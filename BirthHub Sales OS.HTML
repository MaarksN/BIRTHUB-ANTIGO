<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirthHub 360¬∫ Sales OS üöÄ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com">
        // --- NEW WIDGETS LOGIC ---

        // POMODORO
        // DUPLICATE REMOVED: // DUP let pomodoroInterval;
        // DUPLICATE REMOVED: // DUP let pomodoroTime = 25 * 60;
        // DUPLICATE REMOVED: // DUP let isPomodoroRunning = false;

        function renderPomodoro() {
            return `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-bold mb-8 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="clock" class="text-red-500"></i> Pomodoro
                    </h2>
                    <div class="text-7xl font-mono font-bold text-slate-800 dark:text-white mb-8" id="pomo-display">
                        ${formatTime(pomodoroTime)}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="togglePomodoro()" id="pomo-btn" class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-bold text-lg transition-all shadow-lg shadow-red-500/30">
                            INICIAR
                        </button>
                        <button onclick="resetPomodoro()" class="px-6 py-3 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-2xl text-slate-600 dark:text-white font-bold transition-all">
                            RESET
                        </button>
                    </div>
                </div>`;
        }
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (isPomodoroRunning) {
                clearInterval(pomodoroInterval);
                isPomodoroRunning = false;
                btn.innerText = 'CONTINUAR';
                btn.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                isPomodoroRunning = true;
                btn.innerText = 'PAUSAR';
                btn.classList.replace('bg-red-500', 'bg-orange-500');
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    if(pomodoroTime <= 0) {
                        clearInterval(pomodoroInterval);
                        isPomodoroRunning = false;
                        document.getElementById('pomo-display').innerText = "00:00";
                        alert("Pomodoro Finalizado!"); // Simple alert
                        resetPomodoro();
                    } else {
                        document.getElementById('pomo-display').innerText = formatTime(pomodoroTime);
                    }
                }, 1000);
            }
        }
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            pomodoroTime = 25 * 60;
            const display = document.getElementById('pomo-display');
            const btn = document.getElementById('pomo-btn');
            if(display) display.innerText = "25:00";
            if(btn) { btn.innerText = "INICIAR"; btn.classList.remove('bg-orange-500'); btn.classList.add('bg-red-500'); }
        }

        // WORLD CLOCK
        // DUPLICATE REMOVED: // DUP let worldClockInterval;
        function renderWorldClock() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="globe" class="text-blue-500"></i> Rel√≥gio Mundial
                    </h2>
                    <div id="world-clocks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Clocks -->
                    </div>
                </div>`;
        }
        function startWorldClock() {
            updateWorldClocks();
            if(worldClockInterval) clearInterval(worldClockInterval);
            worldClockInterval = setInterval(updateWorldClocks, 1000);
        }
        function updateWorldClocks() {
            const zones = [
                { label: 'S√£o Paulo', tz: 'America/Sao_Paulo' },
                { label: 'New York', tz: 'America/New_York' },
                { label: 'London', tz: 'Europe/London' },
                { label: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            const container = document.getElementById('world-clocks');
            if(!container) return;

            container.innerHTML = zones.map(z => {
                const time = new Date().toLocaleTimeString('en-US', { timeZone: z.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                const date = new Date().toLocaleDateString('pt-BR', { timeZone: z.tz, day: 'numeric', month: 'short' });
                return `
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${z.label}</span>
                    <span class="text-3xl font-mono font-bold text-slate-800 dark:text-white">${time}</span>
                    <span class="text-[10px] text-slate-500">${date}</span>
                </div>`;
            }).join('');
        }

        // OBJECTION COUNTER
        function renderObjectionCounter() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="trello" class="text-purple-500"></i> Contador de Obje√ß√µes
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="obj-input" placeholder="Nova Obje√ß√£o..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addObjection()">
                        <button onclick="addObjection()" class="p-2 bg-purple-500 hover:bg-purple-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="obj-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getObjections() { return JSON.parse(localStorage.getItem('bh_objections') || '[]'); }
        function addObjection() {
            const input = document.getElementById('obj-input');
            const text = input.value.trim();
            if(!text) return;
            const objs = getObjections();
            objs.push({ id: Date.now(), text, count: 0 });
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            input.value = '';
            refreshObjections();
        }
        function updateObjCount(id, delta) {
            const objs = getObjections();
            const obj = objs.find(o => o.id === id);
            if(obj) {
                obj.count = Math.max(0, obj.count + delta);
                localStorage.setItem('bh_objections', JSON.stringify(objs));
                refreshObjections();
            }
        }
        function deleteObjection(id) {
            let objs = getObjections();
            objs = objs.filter(o => o.id !== id);
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            refreshObjections();
        }
        function refreshObjections() {
            const list = document.getElementById('obj-list');
            if(!list) return;
            const objs = getObjections();
            list.innerHTML = objs.map(o => `
                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 group">
                    <span class="flex-1 text-sm font-medium text-slate-700 dark:text-slate-200">${escapeHtml(o.text)}</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-black/20 rounded-lg p-1">
                        <button onclick="updateObjCount(${o.id}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-slate-500">-</button>
                        <span class="text-sm font-bold w-6 text-center text-slate-800 dark:text-white">${o.count}</span>
                        <button onclick="updateObjCount(${o.id}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-purple-500">+</button>
                    </div>
                    <button onclick="deleteObjection(${o.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // QUICK LINKS
        function renderQuickLinks() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="link" class="text-cyan-500"></i> Links R√°pidos
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="link-name" placeholder="Nome" class="w-1/3 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <input type="url" id="link-url" placeholder="URL (https://...)" class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <button onclick="addLink()" class="p-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="link-list" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getLinks() { return JSON.parse(localStorage.getItem('bh_links') || '[]'); }
        function addLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if(!name || !url) return;
            const links = getLinks();
            links.push({ id: Date.now(), name, url });
            localStorage.setItem('bh_links', JSON.stringify(links));
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            refreshLinks();
        }
        function deleteLink(id) {
            let links = getLinks();
            links = links.filter(l => l.id !== id);
            localStorage.setItem('bh_links', JSON.stringify(links));
            refreshLinks();
        }
        function refreshLinks() {
            const list = document.getElementById('link-list');
            if(!list) return;
            const links = getLinks();
            list.innerHTML = links.map(l => `
                <div class="relative group p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 hover:border-cyan-500/30 transition-all">
                    <a href="${escapeHtml(l.url)}" target="_blank" class="flex flex-col items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-center truncate w-full">${escapeHtml(l.name)}</span>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // AFFIRMATION
        function renderAffirmation() {
            const random = affirmations[Math.floor(Math.random() * affirmations.length)];
            return `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-20 h-20 rounded-full bg-yellow-500/10 flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-4 leading-tight">"${random}"</h2>
                    <p class="text-sm text-slate-500 font-medium uppercase tracking-widest">Mantra do Dia</p>
                </div>`;
        }


        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;
            const newSize = document.getElementById('set-fontsize').value;
            const newTone = document.getElementById('set-tone').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            if(newSize) {
                localStorage.setItem('bh_fontsize', newSize);
                applyFontSize(newSize);
            }

            if(newTone) {
                localStorage.setItem('bh_tone', newTone);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            setTimeout(toggleSettings, 500);
        }

        function applyFontSize(size) {
            document.documentElement.classList.remove('text-sm', 'text-base', 'text-lg');
            if(size !== 'text-sm') document.documentElement.classList.add(size);
        }

        function loadSettingsUI() {
            document.getElementById('set-username').value = localStorage.getItem('bh_username') || '';
            document.getElementById('set-apikey').value = localStorage.getItem('bh_apikey') || '';
            document.getElementById('set-webhook').value = localStorage.getItem('bh_webhook') || '';
            document.getElementById('set-fontsize').value = localStorage.getItem('bh_fontsize') || 'text-sm';
            document.getElementById('set-tone').value = localStorage.getItem('bh_tone') || 'professional';
        }

        function exportSettings() {
            const data = {
                username: localStorage.getItem('bh_username'),
                webhook: localStorage.getItem('bh_webhook'),
                theme: localStorage.getItem('bh_theme'),
                fontsize: localStorage.getItem('bh_fontsize'),
                tone: localStorage.getItem('bh_tone'),
                favorites: localStorage.getItem('bh_favorites'),
                links: localStorage.getItem('bh_links'),
                objections: localStorage.getItem('bh_objections')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthhub_config.json';
            a.click();
        }

        function importSettings() {
            document.getElementById('import-file').click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.username) localStorage.setItem('bh_username', data.username);
                    if(data.webhook) localStorage.setItem('bh_webhook', data.webhook);
                    if(data.theme) localStorage.setItem('bh_theme', data.theme);
                    if(data.fontsize) localStorage.setItem('bh_fontsize', data.fontsize);
                    if(data.tone) localStorage.setItem('bh_tone', data.tone);
                    if(data.favorites) localStorage.setItem('bh_favorites', data.favorites);
                    if(data.links) localStorage.setItem('bh_links', data.links);
                    if(data.objections) localStorage.setItem('bh_objections', data.objections);

                    showToast("Importado com Sucesso!");
                    setTimeout(() => location.reload(), 1000);
                } catch(err) {
                    showError("Erro na Importa√ß√£o", "Arquivo inv√°lido.");
                }
            };
            reader.readAsText(file);
        }

        async function sendToCRM() {
            const webhook = localStorage.getItem('bh_webhook');
            if(!webhook) { showError('Erro', 'Configure o Webhook nas configura√ß√µes.'); return; }

            const text = document.getElementById('t-output').innerText;
            if(!text || text.includes('Aguardando')) { showError('Erro', 'Nada para enviar.'); return; }

            try {
                showToast('Enviando...');
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        user: window.userName,
                        content: text
                    })
                });
                showToast('Enviado com Sucesso! üöÄ');
            } catch(e) {
                showError('Falha no Envio', e.message);
            }
        }

function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if(isHidden) {
                loadSettingsUI();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js">
        // --- NEW WIDGETS LOGIC ---

        // POMODORO
        // DUP let pomodoroInterval;
        // DUP let pomodoroTime = 25 * 60;
        // DUP let isPomodoroRunning = false;

        function renderPomodoro() {
            return `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-bold mb-8 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="clock" class="text-red-500"></i> Pomodoro
                    </h2>
                    <div class="text-7xl font-mono font-bold text-slate-800 dark:text-white mb-8" id="pomo-display">
                        ${formatTime(pomodoroTime)}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="togglePomodoro()" id="pomo-btn" class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-bold text-lg transition-all shadow-lg shadow-red-500/30">
                            INICIAR
                        </button>
                        <button onclick="resetPomodoro()" class="px-6 py-3 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-2xl text-slate-600 dark:text-white font-bold transition-all">
                            RESET
                        </button>
                    </div>
                </div>`;
        }
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (isPomodoroRunning) {
                clearInterval(pomodoroInterval);
                isPomodoroRunning = false;
                btn.innerText = 'CONTINUAR';
                btn.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                isPomodoroRunning = true;
                btn.innerText = 'PAUSAR';
                btn.classList.replace('bg-red-500', 'bg-orange-500');
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    if(pomodoroTime <= 0) {
                        clearInterval(pomodoroInterval);
                        isPomodoroRunning = false;
                        document.getElementById('pomo-display').innerText = "00:00";
                        alert("Pomodoro Finalizado!"); // Simple alert
                        resetPomodoro();
                    } else {
                        document.getElementById('pomo-display').innerText = formatTime(pomodoroTime);
                    }
                }, 1000);
            }
        }
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            pomodoroTime = 25 * 60;
            const display = document.getElementById('pomo-display');
            const btn = document.getElementById('pomo-btn');
            if(display) display.innerText = "25:00";
            if(btn) { btn.innerText = "INICIAR"; btn.classList.remove('bg-orange-500'); btn.classList.add('bg-red-500'); }
        }

        // WORLD CLOCK
        // DUP let worldClockInterval;
        function renderWorldClock() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="globe" class="text-blue-500"></i> Rel√≥gio Mundial
                    </h2>
                    <div id="world-clocks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Clocks -->
                    </div>
                </div>`;
        }
        function startWorldClock() {
            updateWorldClocks();
            if(worldClockInterval) clearInterval(worldClockInterval);
            worldClockInterval = setInterval(updateWorldClocks, 1000);
        }
        function updateWorldClocks() {
            const zones = [
                { label: 'S√£o Paulo', tz: 'America/Sao_Paulo' },
                { label: 'New York', tz: 'America/New_York' },
                { label: 'London', tz: 'Europe/London' },
                { label: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            const container = document.getElementById('world-clocks');
            if(!container) return;

            container.innerHTML = zones.map(z => {
                const time = new Date().toLocaleTimeString('en-US', { timeZone: z.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                const date = new Date().toLocaleDateString('pt-BR', { timeZone: z.tz, day: 'numeric', month: 'short' });
                return `
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${z.label}</span>
                    <span class="text-3xl font-mono font-bold text-slate-800 dark:text-white">${time}</span>
                    <span class="text-[10px] text-slate-500">${date}</span>
                </div>`;
            }).join('');
        }

        // OBJECTION COUNTER
        function renderObjectionCounter() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="trello" class="text-purple-500"></i> Contador de Obje√ß√µes
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="obj-input" placeholder="Nova Obje√ß√£o..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addObjection()">
                        <button onclick="addObjection()" class="p-2 bg-purple-500 hover:bg-purple-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="obj-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getObjections() { return JSON.parse(localStorage.getItem('bh_objections') || '[]'); }
        function addObjection() {
            const input = document.getElementById('obj-input');
            const text = input.value.trim();
            if(!text) return;
            const objs = getObjections();
            objs.push({ id: Date.now(), text, count: 0 });
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            input.value = '';
            refreshObjections();
        }
        function updateObjCount(id, delta) {
            const objs = getObjections();
            const obj = objs.find(o => o.id === id);
            if(obj) {
                obj.count = Math.max(0, obj.count + delta);
                localStorage.setItem('bh_objections', JSON.stringify(objs));
                refreshObjections();
            }
        }
        function deleteObjection(id) {
            let objs = getObjections();
            objs = objs.filter(o => o.id !== id);
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            refreshObjections();
        }
        function refreshObjections() {
            const list = document.getElementById('obj-list');
            if(!list) return;
            const objs = getObjections();
            list.innerHTML = objs.map(o => `
                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 group">
                    <span class="flex-1 text-sm font-medium text-slate-700 dark:text-slate-200">${escapeHtml(o.text)}</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-black/20 rounded-lg p-1">
                        <button onclick="updateObjCount(${o.id}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-slate-500">-</button>
                        <span class="text-sm font-bold w-6 text-center text-slate-800 dark:text-white">${o.count}</span>
                        <button onclick="updateObjCount(${o.id}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-purple-500">+</button>
                    </div>
                    <button onclick="deleteObjection(${o.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // QUICK LINKS
        function renderQuickLinks() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="link" class="text-cyan-500"></i> Links R√°pidos
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="link-name" placeholder="Nome" class="w-1/3 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <input type="url" id="link-url" placeholder="URL (https://...)" class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <button onclick="addLink()" class="p-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="link-list" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getLinks() { return JSON.parse(localStorage.getItem('bh_links') || '[]'); }
        function addLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if(!name || !url) return;
            const links = getLinks();
            links.push({ id: Date.now(), name, url });
            localStorage.setItem('bh_links', JSON.stringify(links));
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            refreshLinks();
        }
        function deleteLink(id) {
            let links = getLinks();
            links = links.filter(l => l.id !== id);
            localStorage.setItem('bh_links', JSON.stringify(links));
            refreshLinks();
        }
        function refreshLinks() {
            const list = document.getElementById('link-list');
            if(!list) return;
            const links = getLinks();
            list.innerHTML = links.map(l => `
                <div class="relative group p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 hover:border-cyan-500/30 transition-all">
                    <a href="${escapeHtml(l.url)}" target="_blank" class="flex flex-col items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-center truncate w-full">${escapeHtml(l.name)}</span>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // AFFIRMATION
        function renderAffirmation() {
            const random = affirmations[Math.floor(Math.random() * affirmations.length)];
            return `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-20 h-20 rounded-full bg-yellow-500/10 flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-4 leading-tight">"${random}"</h2>
                    <p class="text-sm text-slate-500 font-medium uppercase tracking-widest">Mantra do Dia</p>
                </div>`;
        }


        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;
            const newSize = document.getElementById('set-fontsize').value;
            const newTone = document.getElementById('set-tone').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            if(newSize) {
                localStorage.setItem('bh_fontsize', newSize);
                applyFontSize(newSize);
            }

            if(newTone) {
                localStorage.setItem('bh_tone', newTone);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            setTimeout(toggleSettings, 500);
        }

        function applyFontSize(size) {
            document.documentElement.classList.remove('text-sm', 'text-base', 'text-lg');
            if(size !== 'text-sm') document.documentElement.classList.add(size);
        }

        function loadSettingsUI() {
            document.getElementById('set-username').value = localStorage.getItem('bh_username') || '';
            document.getElementById('set-apikey').value = localStorage.getItem('bh_apikey') || '';
            document.getElementById('set-webhook').value = localStorage.getItem('bh_webhook') || '';
            document.getElementById('set-fontsize').value = localStorage.getItem('bh_fontsize') || 'text-sm';
            document.getElementById('set-tone').value = localStorage.getItem('bh_tone') || 'professional';
        }

        function exportSettings() {
            const data = {
                username: localStorage.getItem('bh_username'),
                webhook: localStorage.getItem('bh_webhook'),
                theme: localStorage.getItem('bh_theme'),
                fontsize: localStorage.getItem('bh_fontsize'),
                tone: localStorage.getItem('bh_tone'),
                favorites: localStorage.getItem('bh_favorites'),
                links: localStorage.getItem('bh_links'),
                objections: localStorage.getItem('bh_objections')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthhub_config.json';
            a.click();
        }

        function importSettings() {
            document.getElementById('import-file').click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.username) localStorage.setItem('bh_username', data.username);
                    if(data.webhook) localStorage.setItem('bh_webhook', data.webhook);
                    if(data.theme) localStorage.setItem('bh_theme', data.theme);
                    if(data.fontsize) localStorage.setItem('bh_fontsize', data.fontsize);
                    if(data.tone) localStorage.setItem('bh_tone', data.tone);
                    if(data.favorites) localStorage.setItem('bh_favorites', data.favorites);
                    if(data.links) localStorage.setItem('bh_links', data.links);
                    if(data.objections) localStorage.setItem('bh_objections', data.objections);

                    showToast("Importado com Sucesso!");
                    setTimeout(() => location.reload(), 1000);
                } catch(err) {
                    showError("Erro na Importa√ß√£o", "Arquivo inv√°lido.");
                }
            };
            reader.readAsText(file);
        }

        async function sendToCRM() {
            const webhook = localStorage.getItem('bh_webhook');
            if(!webhook) { showError('Erro', 'Configure o Webhook nas configura√ß√µes.'); return; }

            const text = document.getElementById('t-output').innerText;
            if(!text || text.includes('Aguardando')) { showError('Erro', 'Nada para enviar.'); return; }

            try {
                showToast('Enviando...');
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        user: window.userName,
                        content: text
                    })
                });
                showToast('Enviado com Sucesso! üöÄ');
            } catch(e) {
                showError('Falha no Envio', e.message);
            }
        }

function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if(isHidden) {
                loadSettingsUI();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, getDocs, orderBy, limit, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



        // Safe Firebase Config Loading
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch(e) { console.error("Invalid firebase config", e); }
        }

        if (!firebaseConfig) {
            console.warn("Firebase config missing. Using mock to prevent crash.");
            firebaseConfig = {
                apiKey: "mock-api-key",
                authDomain: "mock-project.firebaseapp.com",
                projectId: "mock-project",
                storageBucket: "mock-project.appspot.com",
                messagingSenderId: "000000000000",
                appId: "1:000000000000:web:0000000000000000000000"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'birthhub-360-unified';

        window.db = db;
        window.appId = appId;
        window.auth = auth;

        const initAuth = async () => {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        };
        initAuth();

        window.saveToHistory = async (toolName, content, mode) => {
            if (!auth.currentUser) return;
            try {
                const path = ['artifacts', appId, 'public', 'data', 'history'];
                await addDoc(collection(db, ...path), {
                    tool: toolName,
                    mode: mode,
                    content: content,
                    timestamp: serverTimestamp(),
                    userId: auth.currentUser.uid,
                    operator: window.userName
                });
                showToast(`DADOS SALVOS (${mode})! üíæ`);
            } catch (e) {
                console.error(e);
                showToast("ERRO AO SALVAR.");
            }
        };

        window.loadHistory = async () => {
            const list = document.getElementById('history-list');
            showView('history');

            list.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center opacity-50 py-12">
                    <div class="loader-spinner mb-4"></div>
                    <p class="text-xs font-bold uppercase tracking-widest">Acessando Mem√≥ria...</p>
                </div>`;

            if (!auth.currentUser) {
                list.innerHTML = `<div class="col-span-full text-center p-8 opacity-50 font-bold">Fa√ßa login para ver o hist√≥rico.</div>`;
                return;
            }

            try {
                const path = ['artifacts', appId, 'public', 'data', 'history'];
                const q = query(collection(db, ...path), orderBy("timestamp", "desc"), limit(20));
                const querySnapshot = await getDocs(q);

                if(querySnapshot.empty) {
                     list.innerHTML = `<div class="col-span-full text-center p-8 opacity-50 font-bold uppercase tracking-widest text-xs">Nenhum registro encontrado.</div>`;
                     return;
                }

                list.innerHTML = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('pt-BR') : 'Hoje';
                    // Escape HTML in content for safety in onclick
                    const safeContent = (data.content || "").replace(/"/g, '&quot;').replace(/'/g, "\\'").replace(/`/g, "\\`");

                    return `
                    <div class="glass p-5 rounded-2xl border border-white/5 relative group hover:bg-white/5 transition-all">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-black text-xs uppercase tracking-wide text-white">${data.tool}</h3>
                                <p class="text-[9px] font-bold text-slate-500 uppercase">${data.mode} ‚Ä¢ ${date}</p>
                            </div>
                            <button onclick="deleteHistoryItem('${doc.id}')" class="text-slate-600 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 line-clamp-3 mb-4 leading-relaxed">${data.content}</p>
                        <button onclick="viewHistoryItem(\`${safeContent}\`)" class="w-full py-2 rounded-lg bg-white/5 hover:bg-white/10 text-[9px] font-bold uppercase tracking-widest text-slate-300 transition-colors">
                            Ver Completo
                        </button>
                    </div>
                    `;
                }).join('');
                lucide.createIcons();
            } catch (e) {
                console.error(e);
                list.innerHTML = `<div class="col-span-full text-center text-rose-500 font-bold">Erro ao carregar hist√≥rico.</div>`;
            }
        };

        window.deleteHistoryItem = async (id) => {
            if(!confirm("Tem certeza que deseja apagar?")) return;
            try {
                const path = ['artifacts', appId, 'public', 'data', 'history'];
                await deleteDoc(doc(db, ...path, id));
                showToast("Item Removido! üóëÔ∏è");
                loadHistory();
            } catch(e) { showToast("Erro ao apagar."); }
        };

        window.viewHistoryItem = (content) => {
             showView('tool');
             const output = document.getElementById('t-output');
             output.innerText = content;
        };

        // --- NEW WIDGETS LOGIC ---

        // POMODORO
        // DUP let pomodoroInterval;
        // DUP let pomodoroTime = 25 * 60;
        // DUP let isPomodoroRunning = false;

        function renderPomodoro() {
            return `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-bold mb-8 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="clock" class="text-red-500"></i> Pomodoro
                    </h2>
                    <div class="text-7xl font-mono font-bold text-slate-800 dark:text-white mb-8" id="pomo-display">
                        ${formatTime(pomodoroTime)}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="togglePomodoro()" id="pomo-btn" class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-bold text-lg transition-all shadow-lg shadow-red-500/30">
                            INICIAR
                        </button>
                        <button onclick="resetPomodoro()" class="px-6 py-3 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-2xl text-slate-600 dark:text-white font-bold transition-all">
                            RESET
                        </button>
                    </div>
                </div>`;
        }
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (isPomodoroRunning) {
                clearInterval(pomodoroInterval);
                isPomodoroRunning = false;
                btn.innerText = 'CONTINUAR';
                btn.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                isPomodoroRunning = true;
                btn.innerText = 'PAUSAR';
                btn.classList.replace('bg-red-500', 'bg-orange-500');
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    if(pomodoroTime <= 0) {
                        clearInterval(pomodoroInterval);
                        isPomodoroRunning = false;
                        document.getElementById('pomo-display').innerText = "00:00";
                        alert("Pomodoro Finalizado!"); // Simple alert
                        resetPomodoro();
                    } else {
                        document.getElementById('pomo-display').innerText = formatTime(pomodoroTime);
                    }
                }, 1000);
            }
        }
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            pomodoroTime = 25 * 60;
            const display = document.getElementById('pomo-display');
            const btn = document.getElementById('pomo-btn');
            if(display) display.innerText = "25:00";
            if(btn) { btn.innerText = "INICIAR"; btn.classList.remove('bg-orange-500'); btn.classList.add('bg-red-500'); }
        }

        // WORLD CLOCK
        // DUP let worldClockInterval;
        function renderWorldClock() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="globe" class="text-blue-500"></i> Rel√≥gio Mundial
                    </h2>
                    <div id="world-clocks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Clocks -->
                    </div>
                </div>`;
        }
        function startWorldClock() {
            updateWorldClocks();
            if(worldClockInterval) clearInterval(worldClockInterval);
            worldClockInterval = setInterval(updateWorldClocks, 1000);
        }
        function updateWorldClocks() {
            const zones = [
                { label: 'S√£o Paulo', tz: 'America/Sao_Paulo' },
                { label: 'New York', tz: 'America/New_York' },
                { label: 'London', tz: 'Europe/London' },
                { label: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            const container = document.getElementById('world-clocks');
            if(!container) return;

            container.innerHTML = zones.map(z => {
                const time = new Date().toLocaleTimeString('en-US', { timeZone: z.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                const date = new Date().toLocaleDateString('pt-BR', { timeZone: z.tz, day: 'numeric', month: 'short' });
                return `
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${z.label}</span>
                    <span class="text-3xl font-mono font-bold text-slate-800 dark:text-white">${time}</span>
                    <span class="text-[10px] text-slate-500">${date}</span>
                </div>`;
            }).join('');
        }

        // OBJECTION COUNTER
        function renderObjectionCounter() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="trello" class="text-purple-500"></i> Contador de Obje√ß√µes
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="obj-input" placeholder="Nova Obje√ß√£o..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addObjection()">
                        <button onclick="addObjection()" class="p-2 bg-purple-500 hover:bg-purple-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="obj-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getObjections() { return JSON.parse(localStorage.getItem('bh_objections') || '[]'); }
        function addObjection() {
            const input = document.getElementById('obj-input');
            const text = input.value.trim();
            if(!text) return;
            const objs = getObjections();
            objs.push({ id: Date.now(), text, count: 0 });
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            input.value = '';
            refreshObjections();
        }
        function updateObjCount(id, delta) {
            const objs = getObjections();
            const obj = objs.find(o => o.id === id);
            if(obj) {
                obj.count = Math.max(0, obj.count + delta);
                localStorage.setItem('bh_objections', JSON.stringify(objs));
                refreshObjections();
            }
        }
        function deleteObjection(id) {
            let objs = getObjections();
            objs = objs.filter(o => o.id !== id);
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            refreshObjections();
        }
        function refreshObjections() {
            const list = document.getElementById('obj-list');
            if(!list) return;
            const objs = getObjections();
            list.innerHTML = objs.map(o => `
                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 group">
                    <span class="flex-1 text-sm font-medium text-slate-700 dark:text-slate-200">${escapeHtml(o.text)}</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-black/20 rounded-lg p-1">
                        <button onclick="updateObjCount(${o.id}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-slate-500">-</button>
                        <span class="text-sm font-bold w-6 text-center text-slate-800 dark:text-white">${o.count}</span>
                        <button onclick="updateObjCount(${o.id}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-purple-500">+</button>
                    </div>
                    <button onclick="deleteObjection(${o.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // QUICK LINKS
        function renderQuickLinks() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="link" class="text-cyan-500"></i> Links R√°pidos
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="link-name" placeholder="Nome" class="w-1/3 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <input type="url" id="link-url" placeholder="URL (https://...)" class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <button onclick="addLink()" class="p-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="link-list" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getLinks() { return JSON.parse(localStorage.getItem('bh_links') || '[]'); }
        function addLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if(!name || !url) return;
            const links = getLinks();
            links.push({ id: Date.now(), name, url });
            localStorage.setItem('bh_links', JSON.stringify(links));
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            refreshLinks();
        }
        function deleteLink(id) {
            let links = getLinks();
            links = links.filter(l => l.id !== id);
            localStorage.setItem('bh_links', JSON.stringify(links));
            refreshLinks();
        }
        function refreshLinks() {
            const list = document.getElementById('link-list');
            if(!list) return;
            const links = getLinks();
            list.innerHTML = links.map(l => `
                <div class="relative group p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 hover:border-cyan-500/30 transition-all">
                    <a href="${escapeHtml(l.url)}" target="_blank" class="flex flex-col items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-center truncate w-full">${escapeHtml(l.name)}</span>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // AFFIRMATION
        function renderAffirmation() {
            const random = affirmations[Math.floor(Math.random() * affirmations.length)];
            return `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-20 h-20 rounded-full bg-yellow-500/10 flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-4 leading-tight">"${random}"</h2>
                    <p class="text-sm text-slate-500 font-medium uppercase tracking-widest">Mantra do Dia</p>
                </div>`;
        }


        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;
            const newSize = document.getElementById('set-fontsize').value;
            const newTone = document.getElementById('set-tone').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            if(newSize) {
                localStorage.setItem('bh_fontsize', newSize);
                applyFontSize(newSize);
            }

            if(newTone) {
                localStorage.setItem('bh_tone', newTone);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            setTimeout(toggleSettings, 500);
        }

        function applyFontSize(size) {
            document.documentElement.classList.remove('text-sm', 'text-base', 'text-lg');
            if(size !== 'text-sm') document.documentElement.classList.add(size);
        }

        function loadSettingsUI() {
            document.getElementById('set-username').value = localStorage.getItem('bh_username') || '';
            document.getElementById('set-apikey').value = localStorage.getItem('bh_apikey') || '';
            document.getElementById('set-webhook').value = localStorage.getItem('bh_webhook') || '';
            document.getElementById('set-fontsize').value = localStorage.getItem('bh_fontsize') || 'text-sm';
            document.getElementById('set-tone').value = localStorage.getItem('bh_tone') || 'professional';
        }

        function exportSettings() {
            const data = {
                username: localStorage.getItem('bh_username'),
                webhook: localStorage.getItem('bh_webhook'),
                theme: localStorage.getItem('bh_theme'),
                fontsize: localStorage.getItem('bh_fontsize'),
                tone: localStorage.getItem('bh_tone'),
                favorites: localStorage.getItem('bh_favorites'),
                links: localStorage.getItem('bh_links'),
                objections: localStorage.getItem('bh_objections')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthhub_config.json';
            a.click();
        }

        function importSettings() {
            document.getElementById('import-file').click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.username) localStorage.setItem('bh_username', data.username);
                    if(data.webhook) localStorage.setItem('bh_webhook', data.webhook);
                    if(data.theme) localStorage.setItem('bh_theme', data.theme);
                    if(data.fontsize) localStorage.setItem('bh_fontsize', data.fontsize);
                    if(data.tone) localStorage.setItem('bh_tone', data.tone);
                    if(data.favorites) localStorage.setItem('bh_favorites', data.favorites);
                    if(data.links) localStorage.setItem('bh_links', data.links);
                    if(data.objections) localStorage.setItem('bh_objections', data.objections);

                    showToast("Importado com Sucesso!");
                    setTimeout(() => location.reload(), 1000);
                } catch(err) {
                    showError("Erro na Importa√ß√£o", "Arquivo inv√°lido.");
                }
            };
            reader.readAsText(file);
        }

        async function sendToCRM() {
            const webhook = localStorage.getItem('bh_webhook');
            if(!webhook) { showError('Erro', 'Configure o Webhook nas configura√ß√µes.'); return; }

            const text = document.getElementById('t-output').innerText;
            if(!text || text.includes('Aguardando')) { showError('Erro', 'Nada para enviar.'); return; }

            try {
                showToast('Enviando...');
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        user: window.userName,
                        content: text
                    })
                });
                showToast('Enviado com Sucesso! üöÄ');
            } catch(e) {
                showError('Falha no Envio', e.message);
            }
        }

function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if(isHidden) {
                loadSettingsUI();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '#6366F1',
                            secondary: '#10B981',
                            accent: '#F43F5E',
                            gold: '#F59E0B',
                            dark: '#0F172A',
                            surface: '#1E293B'
                        }
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '2.5rem' },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }

        // --- NEW WIDGETS LOGIC ---

        // POMODORO
        // DUP let pomodoroInterval;
        // DUP let pomodoroTime = 25 * 60;
        // DUP let isPomodoroRunning = false;

        function renderPomodoro() {
            return `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-bold mb-8 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="clock" class="text-red-500"></i> Pomodoro
                    </h2>
                    <div class="text-7xl font-mono font-bold text-slate-800 dark:text-white mb-8" id="pomo-display">
                        ${formatTime(pomodoroTime)}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="togglePomodoro()" id="pomo-btn" class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-bold text-lg transition-all shadow-lg shadow-red-500/30">
                            INICIAR
                        </button>
                        <button onclick="resetPomodoro()" class="px-6 py-3 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-2xl text-slate-600 dark:text-white font-bold transition-all">
                            RESET
                        </button>
                    </div>
                </div>`;
        }
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (isPomodoroRunning) {
                clearInterval(pomodoroInterval);
                isPomodoroRunning = false;
                btn.innerText = 'CONTINUAR';
                btn.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                isPomodoroRunning = true;
                btn.innerText = 'PAUSAR';
                btn.classList.replace('bg-red-500', 'bg-orange-500');
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    if(pomodoroTime <= 0) {
                        clearInterval(pomodoroInterval);
                        isPomodoroRunning = false;
                        document.getElementById('pomo-display').innerText = "00:00";
                        alert("Pomodoro Finalizado!"); // Simple alert
                        resetPomodoro();
                    } else {
                        document.getElementById('pomo-display').innerText = formatTime(pomodoroTime);
                    }
                }, 1000);
            }
        }
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            pomodoroTime = 25 * 60;
            const display = document.getElementById('pomo-display');
            const btn = document.getElementById('pomo-btn');
            if(display) display.innerText = "25:00";
            if(btn) { btn.innerText = "INICIAR"; btn.classList.remove('bg-orange-500'); btn.classList.add('bg-red-500'); }
        }

        // WORLD CLOCK
        // DUP let worldClockInterval;
        function renderWorldClock() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="globe" class="text-blue-500"></i> Rel√≥gio Mundial
                    </h2>
                    <div id="world-clocks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Clocks -->
                    </div>
                </div>`;
        }
        function startWorldClock() {
            updateWorldClocks();
            if(worldClockInterval) clearInterval(worldClockInterval);
            worldClockInterval = setInterval(updateWorldClocks, 1000);
        }
        function updateWorldClocks() {
            const zones = [
                { label: 'S√£o Paulo', tz: 'America/Sao_Paulo' },
                { label: 'New York', tz: 'America/New_York' },
                { label: 'London', tz: 'Europe/London' },
                { label: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            const container = document.getElementById('world-clocks');
            if(!container) return;

            container.innerHTML = zones.map(z => {
                const time = new Date().toLocaleTimeString('en-US', { timeZone: z.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                const date = new Date().toLocaleDateString('pt-BR', { timeZone: z.tz, day: 'numeric', month: 'short' });
                return `
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${z.label}</span>
                    <span class="text-3xl font-mono font-bold text-slate-800 dark:text-white">${time}</span>
                    <span class="text-[10px] text-slate-500">${date}</span>
                </div>`;
            }).join('');
        }

        // OBJECTION COUNTER
        function renderObjectionCounter() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="trello" class="text-purple-500"></i> Contador de Obje√ß√µes
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="obj-input" placeholder="Nova Obje√ß√£o..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addObjection()">
                        <button onclick="addObjection()" class="p-2 bg-purple-500 hover:bg-purple-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="obj-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getObjections() { return JSON.parse(localStorage.getItem('bh_objections') || '[]'); }
        function addObjection() {
            const input = document.getElementById('obj-input');
            const text = input.value.trim();
            if(!text) return;
            const objs = getObjections();
            objs.push({ id: Date.now(), text, count: 0 });
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            input.value = '';
            refreshObjections();
        }
        function updateObjCount(id, delta) {
            const objs = getObjections();
            const obj = objs.find(o => o.id === id);
            if(obj) {
                obj.count = Math.max(0, obj.count + delta);
                localStorage.setItem('bh_objections', JSON.stringify(objs));
                refreshObjections();
            }
        }
        function deleteObjection(id) {
            let objs = getObjections();
            objs = objs.filter(o => o.id !== id);
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            refreshObjections();
        }
        function refreshObjections() {
            const list = document.getElementById('obj-list');
            if(!list) return;
            const objs = getObjections();
            list.innerHTML = objs.map(o => `
                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 group">
                    <span class="flex-1 text-sm font-medium text-slate-700 dark:text-slate-200">${escapeHtml(o.text)}</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-black/20 rounded-lg p-1">
                        <button onclick="updateObjCount(${o.id}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-slate-500">-</button>
                        <span class="text-sm font-bold w-6 text-center text-slate-800 dark:text-white">${o.count}</span>
                        <button onclick="updateObjCount(${o.id}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-purple-500">+</button>
                    </div>
                    <button onclick="deleteObjection(${o.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // QUICK LINKS
        function renderQuickLinks() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="link" class="text-cyan-500"></i> Links R√°pidos
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="link-name" placeholder="Nome" class="w-1/3 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <input type="url" id="link-url" placeholder="URL (https://...)" class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <button onclick="addLink()" class="p-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="link-list" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getLinks() { return JSON.parse(localStorage.getItem('bh_links') || '[]'); }
        function addLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if(!name || !url) return;
            const links = getLinks();
            links.push({ id: Date.now(), name, url });
            localStorage.setItem('bh_links', JSON.stringify(links));
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            refreshLinks();
        }
        function deleteLink(id) {
            let links = getLinks();
            links = links.filter(l => l.id !== id);
            localStorage.setItem('bh_links', JSON.stringify(links));
            refreshLinks();
        }
        function refreshLinks() {
            const list = document.getElementById('link-list');
            if(!list) return;
            const links = getLinks();
            list.innerHTML = links.map(l => `
                <div class="relative group p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 hover:border-cyan-500/30 transition-all">
                    <a href="${escapeHtml(l.url)}" target="_blank" class="flex flex-col items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-center truncate w-full">${escapeHtml(l.name)}</span>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // AFFIRMATION
        function renderAffirmation() {
            const random = affirmations[Math.floor(Math.random() * affirmations.length)];
            return `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-20 h-20 rounded-full bg-yellow-500/10 flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-4 leading-tight">"${random}"</h2>
                    <p class="text-sm text-slate-500 font-medium uppercase tracking-widest">Mantra do Dia</p>
                </div>`;
        }


        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;
            const newSize = document.getElementById('set-fontsize').value;
            const newTone = document.getElementById('set-tone').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            if(newSize) {
                localStorage.setItem('bh_fontsize', newSize);
                applyFontSize(newSize);
            }

            if(newTone) {
                localStorage.setItem('bh_tone', newTone);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            setTimeout(toggleSettings, 500);
        }

        function applyFontSize(size) {
            document.documentElement.classList.remove('text-sm', 'text-base', 'text-lg');
            if(size !== 'text-sm') document.documentElement.classList.add(size);
        }

        function loadSettingsUI() {
            document.getElementById('set-username').value = localStorage.getItem('bh_username') || '';
            document.getElementById('set-apikey').value = localStorage.getItem('bh_apikey') || '';
            document.getElementById('set-webhook').value = localStorage.getItem('bh_webhook') || '';
            document.getElementById('set-fontsize').value = localStorage.getItem('bh_fontsize') || 'text-sm';
            document.getElementById('set-tone').value = localStorage.getItem('bh_tone') || 'professional';
        }

        function exportSettings() {
            const data = {
                username: localStorage.getItem('bh_username'),
                webhook: localStorage.getItem('bh_webhook'),
                theme: localStorage.getItem('bh_theme'),
                fontsize: localStorage.getItem('bh_fontsize'),
                tone: localStorage.getItem('bh_tone'),
                favorites: localStorage.getItem('bh_favorites'),
                links: localStorage.getItem('bh_links'),
                objections: localStorage.getItem('bh_objections')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthhub_config.json';
            a.click();
        }

        function importSettings() {
            document.getElementById('import-file').click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.username) localStorage.setItem('bh_username', data.username);
                    if(data.webhook) localStorage.setItem('bh_webhook', data.webhook);
                    if(data.theme) localStorage.setItem('bh_theme', data.theme);
                    if(data.fontsize) localStorage.setItem('bh_fontsize', data.fontsize);
                    if(data.tone) localStorage.setItem('bh_tone', data.tone);
                    if(data.favorites) localStorage.setItem('bh_favorites', data.favorites);
                    if(data.links) localStorage.setItem('bh_links', data.links);
                    if(data.objections) localStorage.setItem('bh_objections', data.objections);

                    showToast("Importado com Sucesso!");
                    setTimeout(() => location.reload(), 1000);
                } catch(err) {
                    showError("Erro na Importa√ß√£o", "Arquivo inv√°lido.");
                }
            };
            reader.readAsText(file);
        }

        async function sendToCRM() {
            const webhook = localStorage.getItem('bh_webhook');
            if(!webhook) { showError('Erro', 'Configure o Webhook nas configura√ß√µes.'); return; }

            const text = document.getElementById('t-output').innerText;
            if(!text || text.includes('Aguardando')) { showError('Erro', 'Nada para enviar.'); return; }

            try {
                showToast('Enviando...');
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        user: window.userName,
                        content: text
                    })
                });
                showToast('Enviado com Sucesso! üöÄ');
            } catch(e) {
                showError('Falha no Envio', e.message);
            }
        }

function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if(isHidden) {
                loadSettingsUI();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest">
        // --- NEW WIDGETS LOGIC ---

        // POMODORO
        // DUP let pomodoroInterval;
        // DUP let pomodoroTime = 25 * 60;
        // DUP let isPomodoroRunning = false;

        function renderPomodoro() {
            return `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-bold mb-8 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="clock" class="text-red-500"></i> Pomodoro
                    </h2>
                    <div class="text-7xl font-mono font-bold text-slate-800 dark:text-white mb-8" id="pomo-display">
                        ${formatTime(pomodoroTime)}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="togglePomodoro()" id="pomo-btn" class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-bold text-lg transition-all shadow-lg shadow-red-500/30">
                            INICIAR
                        </button>
                        <button onclick="resetPomodoro()" class="px-6 py-3 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-2xl text-slate-600 dark:text-white font-bold transition-all">
                            RESET
                        </button>
                    </div>
                </div>`;
        }
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (isPomodoroRunning) {
                clearInterval(pomodoroInterval);
                isPomodoroRunning = false;
                btn.innerText = 'CONTINUAR';
                btn.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                isPomodoroRunning = true;
                btn.innerText = 'PAUSAR';
                btn.classList.replace('bg-red-500', 'bg-orange-500');
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    if(pomodoroTime <= 0) {
                        clearInterval(pomodoroInterval);
                        isPomodoroRunning = false;
                        document.getElementById('pomo-display').innerText = "00:00";
                        alert("Pomodoro Finalizado!"); // Simple alert
                        resetPomodoro();
                    } else {
                        document.getElementById('pomo-display').innerText = formatTime(pomodoroTime);
                    }
                }, 1000);
            }
        }
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            pomodoroTime = 25 * 60;
            const display = document.getElementById('pomo-display');
            const btn = document.getElementById('pomo-btn');
            if(display) display.innerText = "25:00";
            if(btn) { btn.innerText = "INICIAR"; btn.classList.remove('bg-orange-500'); btn.classList.add('bg-red-500'); }
        }

        // WORLD CLOCK
        // DUP let worldClockInterval;
        function renderWorldClock() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="globe" class="text-blue-500"></i> Rel√≥gio Mundial
                    </h2>
                    <div id="world-clocks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Clocks -->
                    </div>
                </div>`;
        }
        function startWorldClock() {
            updateWorldClocks();
            if(worldClockInterval) clearInterval(worldClockInterval);
            worldClockInterval = setInterval(updateWorldClocks, 1000);
        }
        function updateWorldClocks() {
            const zones = [
                { label: 'S√£o Paulo', tz: 'America/Sao_Paulo' },
                { label: 'New York', tz: 'America/New_York' },
                { label: 'London', tz: 'Europe/London' },
                { label: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            const container = document.getElementById('world-clocks');
            if(!container) return;

            container.innerHTML = zones.map(z => {
                const time = new Date().toLocaleTimeString('en-US', { timeZone: z.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                const date = new Date().toLocaleDateString('pt-BR', { timeZone: z.tz, day: 'numeric', month: 'short' });
                return `
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${z.label}</span>
                    <span class="text-3xl font-mono font-bold text-slate-800 dark:text-white">${time}</span>
                    <span class="text-[10px] text-slate-500">${date}</span>
                </div>`;
            }).join('');
        }

        // OBJECTION COUNTER
        function renderObjectionCounter() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="trello" class="text-purple-500"></i> Contador de Obje√ß√µes
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="obj-input" placeholder="Nova Obje√ß√£o..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addObjection()">
                        <button onclick="addObjection()" class="p-2 bg-purple-500 hover:bg-purple-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="obj-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getObjections() { return JSON.parse(localStorage.getItem('bh_objections') || '[]'); }
        function addObjection() {
            const input = document.getElementById('obj-input');
            const text = input.value.trim();
            if(!text) return;
            const objs = getObjections();
            objs.push({ id: Date.now(), text, count: 0 });
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            input.value = '';
            refreshObjections();
        }
        function updateObjCount(id, delta) {
            const objs = getObjections();
            const obj = objs.find(o => o.id === id);
            if(obj) {
                obj.count = Math.max(0, obj.count + delta);
                localStorage.setItem('bh_objections', JSON.stringify(objs));
                refreshObjections();
            }
        }
        function deleteObjection(id) {
            let objs = getObjections();
            objs = objs.filter(o => o.id !== id);
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            refreshObjections();
        }
        function refreshObjections() {
            const list = document.getElementById('obj-list');
            if(!list) return;
            const objs = getObjections();
            list.innerHTML = objs.map(o => `
                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 group">
                    <span class="flex-1 text-sm font-medium text-slate-700 dark:text-slate-200">${escapeHtml(o.text)}</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-black/20 rounded-lg p-1">
                        <button onclick="updateObjCount(${o.id}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-slate-500">-</button>
                        <span class="text-sm font-bold w-6 text-center text-slate-800 dark:text-white">${o.count}</span>
                        <button onclick="updateObjCount(${o.id}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-purple-500">+</button>
                    </div>
                    <button onclick="deleteObjection(${o.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // QUICK LINKS
        function renderQuickLinks() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="link" class="text-cyan-500"></i> Links R√°pidos
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="link-name" placeholder="Nome" class="w-1/3 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <input type="url" id="link-url" placeholder="URL (https://...)" class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <button onclick="addLink()" class="p-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="link-list" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getLinks() { return JSON.parse(localStorage.getItem('bh_links') || '[]'); }
        function addLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if(!name || !url) return;
            const links = getLinks();
            links.push({ id: Date.now(), name, url });
            localStorage.setItem('bh_links', JSON.stringify(links));
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            refreshLinks();
        }
        function deleteLink(id) {
            let links = getLinks();
            links = links.filter(l => l.id !== id);
            localStorage.setItem('bh_links', JSON.stringify(links));
            refreshLinks();
        }
        function refreshLinks() {
            const list = document.getElementById('link-list');
            if(!list) return;
            const links = getLinks();
            list.innerHTML = links.map(l => `
                <div class="relative group p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 hover:border-cyan-500/30 transition-all">
                    <a href="${escapeHtml(l.url)}" target="_blank" class="flex flex-col items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-center truncate w-full">${escapeHtml(l.name)}</span>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // AFFIRMATION
        function renderAffirmation() {
            const random = affirmations[Math.floor(Math.random() * affirmations.length)];
            return `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-20 h-20 rounded-full bg-yellow-500/10 flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-4 leading-tight">"${random}"</h2>
                    <p class="text-sm text-slate-500 font-medium uppercase tracking-widest">Mantra do Dia</p>
                </div>`;
        }


        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;
            const newSize = document.getElementById('set-fontsize').value;
            const newTone = document.getElementById('set-tone').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            if(newSize) {
                localStorage.setItem('bh_fontsize', newSize);
                applyFontSize(newSize);
            }

            if(newTone) {
                localStorage.setItem('bh_tone', newTone);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            setTimeout(toggleSettings, 500);
        }

        function applyFontSize(size) {
            document.documentElement.classList.remove('text-sm', 'text-base', 'text-lg');
            if(size !== 'text-sm') document.documentElement.classList.add(size);
        }

        function loadSettingsUI() {
            document.getElementById('set-username').value = localStorage.getItem('bh_username') || '';
            document.getElementById('set-apikey').value = localStorage.getItem('bh_apikey') || '';
            document.getElementById('set-webhook').value = localStorage.getItem('bh_webhook') || '';
            document.getElementById('set-fontsize').value = localStorage.getItem('bh_fontsize') || 'text-sm';
            document.getElementById('set-tone').value = localStorage.getItem('bh_tone') || 'professional';
        }

        function exportSettings() {
            const data = {
                username: localStorage.getItem('bh_username'),
                webhook: localStorage.getItem('bh_webhook'),
                theme: localStorage.getItem('bh_theme'),
                fontsize: localStorage.getItem('bh_fontsize'),
                tone: localStorage.getItem('bh_tone'),
                favorites: localStorage.getItem('bh_favorites'),
                links: localStorage.getItem('bh_links'),
                objections: localStorage.getItem('bh_objections')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthhub_config.json';
            a.click();
        }

        function importSettings() {
            document.getElementById('import-file').click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.username) localStorage.setItem('bh_username', data.username);
                    if(data.webhook) localStorage.setItem('bh_webhook', data.webhook);
                    if(data.theme) localStorage.setItem('bh_theme', data.theme);
                    if(data.fontsize) localStorage.setItem('bh_fontsize', data.fontsize);
                    if(data.tone) localStorage.setItem('bh_tone', data.tone);
                    if(data.favorites) localStorage.setItem('bh_favorites', data.favorites);
                    if(data.links) localStorage.setItem('bh_links', data.links);
                    if(data.objections) localStorage.setItem('bh_objections', data.objections);

                    showToast("Importado com Sucesso!");
                    setTimeout(() => location.reload(), 1000);
                } catch(err) {
                    showError("Erro na Importa√ß√£o", "Arquivo inv√°lido.");
                }
            };
            reader.readAsText(file);
        }

        async function sendToCRM() {
            const webhook = localStorage.getItem('bh_webhook');
            if(!webhook) { showError('Erro', 'Configure o Webhook nas configura√ß√µes.'); return; }

            const text = document.getElementById('t-output').innerText;
            if(!text || text.includes('Aguardando')) { showError('Erro', 'Nada para enviar.'); return; }

            try {
                showToast('Enviando...');
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        user: window.userName,
                        content: text
                    })
                });
                showToast('Enviado com Sucesso! üöÄ');
            } catch(e) {
                showError('Falha no Envio', e.message);
            }
        }

function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if(isHidden) {
                loadSettingsUI();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }
    </script>

    <style>
        :root { --font-main: 'Plus Jakarta Sans', sans-serif; --font-head: 'Outfit', sans-serif; }
        body { font-family: var(--font-main); transition: background 0.5s ease; overflow-x: hidden; }

        .dark body {
            background-color: #0F172A;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: #f8fafc;
        }
        .light body {
            background-color: #F8FAFC;
            background-image: radial-gradient(at 0% 0%, hsla(210,100%,96%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(250,100%,98%,1) 0, transparent 50%);
            color: #1e293b;
        }
        h1, h2, h3 { font-family: var(--font-head); }
        .glass { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.1); }
        .dark .glass { background: rgba(15, 23, 42, 0.65); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .light .glass { background: rgba(255, 255, 255, 0.85); border-color: rgba(0, 0, 0, 0.05); }

        .tool-card { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); opacity: 0; transform: translateY(20px); animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .tool-card:hover { transform: translateY(-4px) scale(1.01); box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.3); border-color: rgba(99, 102, 241, 0.5); }
        @keyframes popIn { to { opacity: 1; transform: translateY(0); } }

        .view-section { display: none; opacity: 0; transform: scale(0.95); transition: opacity 0.4s ease, transform 0.4s ease; }
        .view-active { display: block; opacity: 1; transform: scale(1); animation: fadeInView 0.5s ease-out forwards; }
        @keyframes fadeInView { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6366F1; border-radius: 20px; }
        .loader-spinner { border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid currentColor; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        input, textarea, select { transition: all 0.2s ease; }
        input:focus, textarea:focus, select:focus { transform: translateY(-1px); }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.5rem;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
</style>
</head>
<body class="min-h-screen pb-12 selection:bg-brand-primary selection:text-white">

    <!-- Header Unified -->
    <header class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] w-[92%] max-w-7xl glass rounded-full px-6 py-2.5 flex items-center justify-between shadow-2xl backdrop-blur-xl transition-all duration-500">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="goHome()">
            <div id="header-logo-bg" class="w-10 h-10 bg-gradient-to-br from-brand-primary to-purple-600 rounded-full flex items-center justify-center shadow-lg group-hover:rotate-12 transition-transform duration-300">
                <i data-lucide="layers" class="w-5 h-5 text-white"></i>
            </div>
            <div>
                <h1 class="font-extrabold text-lg tracking-tight leading-none dark:text-white text-slate-900 group-hover:text-brand-primary transition-colors">BirthHub <span id="header-sub" class="text-transparent bg-clip-text bg-gradient-to-r from-brand-primary to-pink-500">360¬∫ OS</span></h1>
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mt-0.5 flex items-center gap-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span id="greeting-text">MARCELO ONLINE</span>
                </p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col text-right">
                <p class="text-[10px] font-black text-slate-400 font-mono tracking-widest" id="header-time">00:00</p>
                <p class="text-[8px] font-bold text-slate-500 uppercase" id="header-date">--/--</p>
            </div>
            <div class="hidden md:flex relative group mr-2">
                <input type="text" id="tool-search" placeholder="Buscar (Alt+F)..." oninput="renderGrid(currentModule)" class="bg-white/5 border border-white/10 rounded-full px-4 py-1.5 pl-9 text-[11px] font-bold text-slate-300 w-32 focus:w-48 outline-none focus:border-brand-primary transition-all placeholder:text-slate-600">
                <i data-lucide="search" class="absolute left-3 top-2 w-3.5 h-3.5 text-slate-500 group-focus-within:text-brand-primary transition-colors"></i>
            </div>
            <button onclick="loadHistory()" class="w-9 h-9 rounded-full glass hover:bg-white/10 flex items-center justify-center transition-all active:scale-90 group mr-2">
                <i data-lucide="history" class="w-4 h-4 text-slate-400 group-hover:text-white transition-colors"></i>
            </button>
            <button onclick="toggleSettings()" class="w-9 h-9 rounded-full glass hover:bg-white/10 flex items-center justify-center transition-all active:scale-90 group mr-2">
                <i data-lucide="settings" class="w-4 h-4 text-slate-400 group-hover:text-white transition-colors"></i>
            </button>
            <button onclick="toggleTheme()" class="w-9 h-9 rounded-full glass hover:bg-white/10 flex items-center justify-center transition-all active:scale-90 group">
                <i id="theme-icon" data-lucide="moon" class="w-4 h-4 text-indigo-400 group-hover:text-yellow-400 transition-colors"></i>
            </button>
            <button onclick="toggleFullscreen()" title="Alt+F" class="w-9 h-9 rounded-full glass hover:bg-white/10 flex items-center justify-center transition-all active:scale-90 group ml-2">
                <i data-lucide="expand" class="w-4 h-4 text-slate-400 group-hover:text-white transition-colors"></i>
            </button>
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto p-4 mt-24">

        <!-- HUB CENTRAL (Menu Principal) -->
        <div id="view-hub" class="view-section view-active min-h-[70vh] flex flex-col items-center justify-center">
            <div class="text-center mb-5 animate-[popIn_0.5s_ease-out]">
                <h2 class="text-3xl md:text-5xl font-black tracking-tighter mb-0.5 dark:text-white text-slate-900">SALES <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500">OS</span></h2>
                <p class="text-slate-500 font-bold uppercase tracking-[0.3em] text-[9px]">Selecione o M√≥dulo Operacional</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 w-full max-w-4xl px-4">
                <!-- BDR Module -->
                <div onclick="selectModule('bdr')" class="group relative p-4 rounded-3xl glass cursor-pointer overflow-hidden hover:border-indigo-500/50 transition-all hover:-translate-y-1 tool-card border border-transparent shadow-sm" style="animation-delay: 0.1s">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-indigo-500/10 text-indigo-500 flex items-center justify-center group-hover:scale-90 transition-transform flex-shrink-0">
                            <i data-lucide="scan-search" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-black uppercase tracking-tighter leading-none mb-0.5">BDR <span class="text-indigo-500 text-[10px] inline-block ml-1">Intel</span></h3>
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest truncate">Research & Pre-Sales</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0"></i>
                    </div>
                    <div class="w-full h-0.5 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-3">
                        <div class="h-full bg-indigo-500 w-0 group-hover:w-full transition-all duration-300 ease-out"></div>
                    </div>
                </div>

                <!-- SDR Module -->
                <div onclick="selectModule('sdr')" class="group relative p-4 rounded-3xl glass cursor-pointer overflow-hidden hover:border-rose-500/50 transition-all hover:-translate-y-1 tool-card border border-transparent shadow-sm" style="animation-delay: 0.2s">
                    <div class="absolute inset-0 bg-gradient-to-br from-rose-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-rose-500/10 text-rose-500 flex items-center justify-center group-hover:scale-90 transition-transform flex-shrink-0">
                            <i data-lucide="flame" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-black uppercase tracking-tighter leading-none mb-0.5">SDR <span class="text-rose-500 text-[10px] inline-block ml-1">Hunter</span></h3>
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest truncate">Outbound & Qualifica√ß√£o</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0"></i>
                    </div>
                    <div class="w-full h-0.5 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-3">
                        <div class="h-full bg-rose-500 w-0 group-hover:w-full transition-all duration-300 ease-out"></div>
                    </div>
                </div>

                <!-- Closer Module -->
                <div onclick="selectModule('closer')" class="group relative p-4 rounded-3xl glass cursor-pointer overflow-hidden hover:border-amber-500/50 transition-all hover:-translate-y-1 tool-card border border-transparent shadow-sm" style="animation-delay: 0.3s">
                    <div class="absolute inset-0 bg-gradient-to-br from-amber-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-amber-500/10 text-amber-500 flex items-center justify-center group-hover:scale-90 transition-transform flex-shrink-0">
                            <i data-lucide="crown" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-black uppercase tracking-tighter leading-none mb-0.5">Closer <span class="text-amber-500 text-[10px] inline-block ml-1">Elite</span></h3>
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest truncate">Negocia√ß√£o & Fecho</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0"></i>
                    </div>
                    <div class="w-full h-0.5 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-3">
                        <div class="h-full bg-amber-500 w-0 group-hover:w-full transition-all duration-300 ease-out"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRID DE FERRAMENTAS -->
        <div id="view-grid" class="view-section">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6 px-2">
                <div>
                    <span id="module-badge" class="inline-block py-0.5 px-2 rounded-full bg-white/5 text-white text-[9px] font-black uppercase tracking-widest mb-2 border border-white/10">M√≥dulo Selecionado</span>
                    <h2 class="text-2xl font-black tracking-tight dark:text-white text-slate-900 flex items-center gap-2">
                        Arsenal <span class="emoji-float" id="module-emoji">‚ö°</span>
                    </h2>
                </div>
                <button onclick="goHome()" class="px-5 py-2 glass rounded-full text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 flex items-center gap-2 transition-all active:scale-95">
                    <i data-lucide="layout-grid" class="w-3 h-3"></i> MENU
                </button>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3" id="tool-grid">
                <!-- Cards renderizados via JS -->
            </div>
        </div>

        <!-- HISTORY VIEW -->
        <div id="view-history" class="view-section">
             <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6 px-2">
                <div>
                    <span class="inline-block py-0.5 px-2 rounded-full bg-white/5 text-white text-[9px] font-black uppercase tracking-widest mb-2 border border-white/10">Mem√≥ria do Sistema</span>
                    <h2 class="text-2xl font-black tracking-tight dark:text-white text-slate-900 flex items-center gap-2">
                        Hist√≥rico <span class="emoji-float">üìÇ</span></h2></div><button onclick="exportHistoryCSV()" class="px-4 py-2 bg-indigo-500/10 text-indigo-500 hover:bg-indigo-500 hover:text-white text-xs font-bold rounded-xl transition-all flex items-center gap-2 shadow-sm"><i data-lucide="download" class="w-4 h-4"></i> CSV</button>
                <button onclick="goHome()" class="px-5 py-2 glass rounded-full text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 flex items-center gap-2 transition-all active:scale-95">
                    <i data-lucide="layout-grid" class="w-3 h-3"></i> MENU
                </button>
            </div>

            <div id="history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- History Items Rendered Here -->
            </div>
        </div>

        <!-- TOOL EXECUTION VIEW -->
        <div id="view-tool" class="view-section">
            <div id="tool-container" class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                <!-- Injetado via JS -->
            </div>
        </div>

    </main>

    <!-- Chat Mentor Global -->
    <div id="chat-window" class="fixed bottom-24 right-8 w-80 h-[450px] glass rounded-[2rem] shadow-2xl z-[200] hidden flex flex-col overflow-hidden border-2 border-white/5 transition-transform duration-300 origin-bottom-right">
        <div id="chat-header" class="p-4 bg-gradient-to-r from-brand-primary to-indigo-600 text-white flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="p-1.5 bg-white/20 rounded-lg"><i data-lucide="bot" class="w-4 h-4"></i></div>
                <div>
                    <h3 class="font-black text-xs uppercase tracking-wide">Mentor <span id="chat-mode-text">Sales</span></h3>
                    <p class="text-[9px] opacity-80 font-medium">Gemini 2.5 Live</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="p-1.5 hover:bg-white/20 rounded-full transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>

        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3 custom-scrollbar bg-slate-50/50 dark:bg-slate-900/50 backdrop-blur-sm">
            <div class="flex gap-2">
                <div class="w-6 h-6 rounded-full bg-indigo-500 flex-shrink-0 flex items-center justify-center text-white text-[9px] font-bold">IA</div>
                <div class="bg-white dark:bg-slate-800 p-3 rounded-xl rounded-tl-none shadow-sm text-[11px] leading-relaxed text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
                    Ol√° Marcelo! Em que fase do funil vamos focar agora? Estou pronto. üöÄ
                </div>
            </div>
        </div>

        <div class="p-3 bg-white/80 dark:bg-slate-900/80 backdrop-blur border-t border-slate-200 dark:border-white/5 flex gap-2">
            <input id="chat-input" type="text" placeholder="D√∫vida estrat√©gica..." class="flex-1 bg-slate-100 dark:bg-slate-800 rounded-full px-4 py-2 text-[11px] font-medium outline-none focus:ring-2 focus:ring-brand-primary/50 transition-all dark:text-white text-slate-900 border border-transparent">
            <button onclick="sendChatMessage()" class="w-8 h-8 bg-brand-primary rounded-full text-white shadow-lg hover:bg-indigo-500 active:scale-90 transition-all flex items-center justify-center">
                <i data-lucide="send" class="w-3 h-3 ml-0.5"></i>
            </button>
        </div>
    </div>

    <!-- Floating Actions -->
    <div class="fixed bottom-6 right-6 flex flex-col gap-3 z-[150]">
        <button onclick="startGlobalVoice()" id="voice-btn" class="w-12 h-12 bg-gradient-to-tr from-rose-500 to-pink-600 rounded-full flex items-center justify-center shadow-lg shadow-rose-500/30 hover:scale-110 hover:-translate-y-1 transition-all border-2 border-white/10 group">
            <i data-lucide="mic" class="w-5 h-5 text-white group-hover:animate-pulse"></i>
        </button>
        <button onclick="toggleChat()" class="w-12 h-12 bg-gradient-to-tr from-brand-primary to-indigo-600 rounded-full flex items-center justify-center shadow-lg shadow-indigo-500/30 hover:scale-110 hover:-translate-y-1 transition-all border-2 border-white/10 group">
            <i data-lucide="message-circle" class="w-5 h-5 text-white"></i>
            <span class="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900"></span>
        </button>
    </div>

    <!-- Toast -->
    <div id="toast-msg" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-full font-black shadow-2xl opacity-0 translate-y-10 transition-all duration-300 pointer-events-none z-[250] text-[10px] uppercase tracking-widest flex items-center gap-2 border border-white/10">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
        <span>A√ß√£o Realizada!</span>
    </div>

    <script>
        // CONFIG
        window.apiKey = localStorage.getItem('bh_apikey') || "";
        window.userName = localStorage.getItem('bh_username') || "MARCELO";
        window.crmUrl = localStorage.getItem('bh_webhook') || "";

        const getEndpoints = () => ({
            text: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${window.apiKey}`,
            image: `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${window.apiKey}`,
            tts: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${window.apiKey}`
        });

        let endpoints = getEndpoints();

        let currentModule = 'hub';
        let roleplayHistory = {};

        // MASTER TOOL LIST - COM CAMPOS APRIMORADOS PARA GEMINI 2.5
        const masterTools = [
            { id: 'widget_pomodoro', type: 'widget', widgetType: 'pomodoro', modules: ['hub', 'sdr', 'closer'], name: 'Pomodoro', icon: 'clock', color: 'red', emoji: 'üçÖ', desc: 'Timer de Foco' },
            { id: 'widget_worldclock', type: 'widget', widgetType: 'worldclock', modules: ['hub', 'bdr'], name: 'Fuso Hor√°rio', icon: 'globe', color: 'blue', emoji: 'üåç', desc: 'Rel√≥gio Mundial' },
            { id: 'widget_counter', type: 'widget', widgetType: 'counter', modules: ['sdr', 'closer'], name: 'Contador de Obje√ß√µes', icon: 'trello', color: 'purple', emoji: 'üî¢', desc: 'Tracking de ' },
            { id: 'widget_links', type: 'widget', widgetType: 'links', modules: ['hub'], name: 'Links R√°pidos', icon: 'link', color: 'cyan', emoji: 'üîó', desc: 'Favoritos' },
            { id: 'widget_affirmation', type: 'widget', widgetType: 'affirmation', modules: ['hub', 'leader'], name: 'Motiva√ß√£o Di√°ria', icon: 'sun', color: 'yellow', emoji: '‚òÄÔ∏è', desc: 'Cita√ß√µes' },
            // --- Productivity Widgets ---
            { id: 'widget_scratchpad', type: 'widget', widgetType: 'scratchpad', modules: ['hub', 'bdr', 'sdr', 'closer', 'leader'], name: 'Bloco de Notas', icon: 'file-text', color: 'slate', emoji: 'üìù', desc: 'Anota√ß√µes R√°pidas' },
            { id: 'widget_goals', type: 'widget', widgetType: 'goals', modules: ['hub', 'leader'], name: 'Metas', icon: 'target', color: 'emerald', emoji: 'üéØ', desc: 'Tracking de Objetivos' },
            { id: 'widget_calc', type: 'widget', widgetType: 'calculator', modules: ['hub', 'bdr', 'sdr', 'closer'], name: 'Calculadora', icon: 'calculator', color: 'orange', emoji: 'üßÆ', desc: 'C√°lculos R√°pidos' },
            // --- BDR Tools ---
            {
                id: 'bdr_vision', modules: ['bdr', 'sdr'], name: 'Vision Intel', icon: 'eye', color: 'cyan', emoji: 'üëÅÔ∏è', desc: 'An√°lise de Prints',
                prompt: 'Voc√™ √© um BDR S√™nior. Analise esta imagem com vis√£o computacional. Identifique oportunidades de venda.', acceptsImage: true,
                fields: [
                    { id: 'focus', label: 'Foco da An√°lise', type: 'select', options: ['Tecnologias Utilizadas', 'Estrutura do Time', 'Dores/Gaps Vis√≠veis', 'Not√≠cias/Expans√£o'] },
                    { id: 'ctx', label: 'Contexto Extra', type: 'text', placeholder: 'Ex: Vendemos software de RH' }
                ]
            },
            {
                id: 'bdr_content', modules: ['bdr'], name: 'Ghostwriter', icon: 'pen-tool', color: 'pink', emoji: 'üëª', desc: 'LinkedIn Viral',
                prompt: 'Voc√™ √© um Copywriter Top Voice do LinkedIn especializado em B2B.',
                fields: [
                    { id: 'topic', label: 'Tema do Post', type: 'text', placeholder: 'Ex: Erros na contrata√ß√£o de Tech' },
                    { id: 'audience', label: 'P√∫blico Alvo', type: 'text', placeholder: 'Ex: CTOs de Startups' },
                    { id: 'style', label: 'Estilo', type: 'select', options: ['Pol√™mico/Contrarian', 'Storytelling Emocional', 'Lista Pr√°tica (How-to)', 'An√°lise de Dados'] }
                ]
            },
            {
                id: 'bdr_script', modules: ['bdr'], name: 'Script BDR', icon: 'zap', color: 'indigo', emoji: 'üìù', desc: 'AIDA & Persuas√£o',
                prompt: 'Voc√™ √© um especialista em Cold Calling e Scripts.',
                fields: [
                    { id: 'prospect', label: 'Cargo do Lead', type: 'text', placeholder: 'Ex: Diretor de Marketing' },
                    { id: 'company', label: 'Nome da Empresa', type: 'text', placeholder: 'Ex: Fintech X' },
                    { id: 'value_prop', label: 'Proposta de Valor', type: 'textarea', placeholder: 'Ex: Reduzimos o CAC em 30%...' },
                    { id: 'framework', label: 'Framework', type: 'select', options: ['AIDA (Aten√ß√£o, Interesse...)', 'PAS (Problema, Agita√ß√£o...)', 'Depoimento/Prova Social'] }
                ]
            },
            {
                id: 'bdr_summary', modules: ['bdr', 'sdr'], name: 'Resumo Web', icon: 'globe', color: 'blue', emoji: 'üåê', desc: 'News & Dores Atuais',
                prompt: 'Realize uma pesquisa profunda na web sobre a empresa alvo.', useSearch: true,
                fields: [
                    { id: 'company', label: 'Empresa Alvo', type: 'text', placeholder: 'Ex: Coca-Cola Brasil' },
                    { id: 'focus', label: 'O que buscar?', type: 'select', options: ['Not√≠cias Recentes', 'Sa√∫de Financeira/Layoffs', 'Lan√ßamentos de Produtos', 'Fus√µes e Aquisi√ß√µes'] }
                ]
            },

            // --- SDR Tools ---
            {
                id: 'roleplay_gk', modules: ['sdr'], name: 'Roleplay: Secret√°ria', icon: 'shield', color: 'orange', emoji: 'üõ°Ô∏è', desc: 'Simulador em Chat', isChat: true,
                persona: 'Uma secret√°ria executiva protetora e experiente. Sua miss√£o √© bloquear vendedores. Use desculpas como "est√° em reuni√£o", "mande por email".',
                firstMsg: 'Bom dia, escrit√≥rio da Diretoria. Quem deseja falar?'
            },
            {
                id: 'sdr_cadence', modules: ['sdr'], name: 'Cad√™ncia Total', icon: 'layers', color: 'rose', emoji: 'üìÖ', desc: 'Fluxo de Prospec√ß√£o',
                prompt: 'Crie uma cad√™ncia de prospec√ß√£o outbound multicanal.',
                fields: [
                    { id: 'persona', label: 'Persona Alvo', type: 'text', placeholder: 'Ex: Gerente de Log√≠stica' },
                    { id: 'sector', label: 'Setor', type: 'text', placeholder: 'Ex: Varejo' },
                    { id: 'duration', label: 'Dura√ß√£o', type: 'select', options: ['15 Dias (Agressiva)', '30 Dias (Consultiva)'] }
                ]
            },
            {
                id: 'sdr_coldcall', modules: ['sdr'], name: 'Cold Call Sim', icon: 'phone-incoming', color: 'orange', emoji: 'üìû', desc: 'Simulador de Obje√ß√µes',
                prompt: 'Atue como um prospect que recebeu uma liga√ß√£o fria.',
                fields: [
                    { id: 'pitch', label: 'Seu Pitch Inicial', type: 'textarea', placeholder: 'Cole aqui como voc√™ come√ßa a liga√ß√£o...' },
                    { id: 'difficulty', label: 'N√≠vel de Dificuldade', type: 'select', options: ['F√°cil (Curioso)', 'M√©dio (C√©tico)', 'Dif√≠cil (Ocupado/Rude)'] }
                ]
            },

            // --- Closer Tools ---
            {
                id: 'closer_warroom', modules: ['closer'], name: 'Deal War Room', icon: 'users', color: 'indigo', emoji: 'üèõÔ∏è', desc: 'Simula√ß√£o Multi-Agente',
                prompt: 'Simule um di√°logo privado (formato script) entre os C-Levels da empresa sobre a compra.',
                fields: [
                    { id: 'company', label: 'Empresa', type: 'text', placeholder: 'Ex: Enterprise Co.' },
                    { id: 'deal_value', label: 'Valor do Contrato', type: 'text', placeholder: 'Ex: R$ 500k/ano' },
                    { id: 'stakeholders', label: 'Envolvidos', type: 'text', placeholder: 'Ex: CEO, CFO, CTO' }
                ]
            },
            {
                id: 'roleplay_cfo', modules: ['closer'], name: 'Roleplay: CFO C√©tico', icon: 'user-x', color: 'red', emoji: 'üò§', desc: 'Negocia√ß√£o Tensa', isChat: true,
                persona: 'Um CFO anal√≠tico, focado exclusivamente em EBITDA e redu√ß√£o de custos. Voc√™ odeia risco. Questione cada centavo.',
                firstMsg: 'Tenho exatos 5 minutos. Me d√™ um motivo financeiro para n√£o vetar esse projeto agora.'
            },
            {
                id: 'close_email', modules: ['closer'], name: 'Email Closer', icon: 'mail-check', color: 'sky', emoji: 'üìß', desc: 'Respostas Finais',
                prompt: 'Escreva um e-mail de fechamento decisivo.',
                fields: [
                    { id: 'situation', label: 'Situa√ß√£o Atual', type: 'textarea', placeholder: 'Ex: Cliente pediu desconto e parou de responder...' },
                    { id: 'strategy', label: 'Estrat√©gia', type: 'select', options: ['Desapego (Break-up)', 'Urg√™ncia (Gatilho Temporal)', 'Concess√£o Estrat√©gica', 'Recap de Valor'] }
                ]
            },

            // --- Visual & Creative (All Modules) ---
            {
                id: 'gen_persona', modules: ['bdr', 'sdr', 'closer'], name: 'Visual Persona', icon: 'image', color: 'cyan', emoji: 'üë§', desc: 'Retrato ICP',
                prompt: 'Gere um retrato fotorealista profissional de est√∫dio.', acceptsImage: false, isImage: true,
                fields: [
                    { id: 'job', label: 'Cargo', type: 'text', placeholder: 'Ex: CEO de Startup' },
                    { id: 'age', label: 'Idade Aprox.', type: 'text', placeholder: 'Ex: 45 anos' },
                    { id: 'vibe', label: 'Ambiente/Vibe', type: 'text', placeholder: 'Ex: Escrit√≥rio moderno, confiante' }
                ]
            }
        ,
            { id: 'sdr_cold_email_aida', modules: ['sdr'], name: 'Cold Email AIDA', icon: 'mail', color: 'blue', emoji: 'üìß', desc: 'Email Frio Cl√°ssico', prompt: 'Escreva um cold email usando a estrutura AIDA (Aten√ß√£o, Interesse, Desejo, A√ß√£o) para o prospect.' },
            { id: 'sdr_linkedin_connect', modules: ['sdr'], name: 'LinkedIn Connect', icon: 'linkedin', color: 'blue', emoji: 'üîó', desc: 'Pedido de Conex√£o', prompt: 'Crie 3 varia√ß√µes de nota de conex√£o no LinkedIn (max 300 chars) que sejam personalizadas e n√£o vendas.' },
            { id: 'sdr_gatekeeper', modules: ['sdr'], name: 'Gatekeeper Script', icon: 'shield', color: 'slate', emoji: 'üõ°Ô∏è', desc: 'Passar pela Secret√°ria', prompt: 'Crie um script para passar pelo Gatekeeper (secret√°ria/recep√ß√£o) com autoridade e empatia.' },
            { id: 'sdr_voicemail', modules: ['sdr'], name: 'Voicemail Matador', icon: 'voicemail', color: 'orange', emoji: '‚ûø', desc: 'Script de Caixa Postal', prompt: 'Escreva um script de voicemail de 30 segundos que desperte curiosidade e fa√ßa o prospect retornar.' },
            { id: 'sdr_followup', modules: ['sdr'], name: 'Follow-up Email', icon: 'repeat', color: 'indigo', emoji: 'üîÅ', desc: 'Email de Cobran√ßa', prompt: 'Escreva um email de follow-up gentil para quem n√£o respondeu ao primeiro contato.' },
            { id: 'sdr_breakup', modules: ['sdr'], name: 'Break-up Email', icon: 'x-circle', color: 'red', emoji: 'üíî', desc: 'Email de Despedida', prompt: 'Escreva um "Break-up Email" (email de despedida) usando gatilho de avers√£o √† perda.' },
            { id: 'disc_spin', modules: ['sdr', 'closer'], name: 'SPIN Selling', icon: 'help-circle', color: 'green', emoji: 'üåÄ', desc: 'Perguntas SPIN', prompt: 'Gere perguntas de Situa√ß√£o, Problema, Implica√ß√£o e Necessidade de Solu√ß√£o para este cen√°rio.' },
            { id: 'disc_meddic', modules: ['closer'], name: 'MEDDIC Check', icon: 'check-square', color: 'emerald', emoji: '‚úÖ', desc: 'Checklist MEDDIC', prompt: 'Analise o cen√°rio e crie perguntas para cobrir: Metrics, Economic Buyer, Decision Criteria, Decision Process, Identify Pain, Champion.' },
            { id: 'disc_bant', modules: ['sdr', 'closer'], name: 'BANT Qualifier', icon: 'filter', color: 'yellow', emoji: 'üè¶', desc: 'Budget & Authority', prompt: 'Crie perguntas sutis para qualificar Budget, Authority, Need e Timing sem parecer um interrogat√≥rio.' },
            { id: 'disc_gap', modules: ['closer'], name: 'GAP Selling', icon: 'maximize-2', color: 'purple', emoji: '‚ÜîÔ∏è', desc: 'An√°lise de Lacunas', prompt: 'Ajude a identificar o Estado Atual vs Estado Futuro e a lacuna (GAP) entre eles.' },
            { id: 'disc_sandler', modules: ['closer'], name: 'Sandler Pain', icon: 'frown', color: 'pink', emoji: 'üòñ', desc: 'Funil da Dor', prompt: 'Use o Sandler Pain Funnel para aprofundar a dor do cliente com perguntas em camadas.' },
            { id: 'obj_price', modules: ['closer', 'sdr'], name: 'Obje√ß√£o: Pre√ßo', icon: 'dollar-sign', color: 'red', emoji: 'üí∏', desc: 'Est√° muito caro', prompt: 'Forne√ßa 3 respostas para a obje√ß√£o "O pre√ßo est√° alto demais" focado em valor/ROI.' },
            { id: 'obj_sendinfo', modules: ['sdr'], name: 'Obje√ß√£o: Me manda info', icon: 'send', color: 'blue', emoji: 'üì®', desc: 'Manda por email', prompt: 'Como responder a "Me manda uma apresenta√ß√£o por email" para tentar manter a conversa viva?' },
            { id: 'obj_not_interested', modules: ['sdr'], name: 'Obje√ß√£o: Sem interesse', icon: 'thumbs-down', color: 'slate', emoji: 'üòê', desc: 'N√£o tenho interesse', prompt: 'Como reverter um "N√£o tenho interesse" logo no in√≠cio da call?' },
            { id: 'obj_competitor', modules: ['closer'], name: 'Obje√ß√£o: Concorrente', icon: 'swords', color: 'orange', emoji: 'üÜö', desc: 'Uso o concorrente', prompt: 'Como responder a "J√° usamos o concorrente X e estamos felizes"?' },
            { id: 'obj_budget', modules: ['closer'], name: 'Obje√ß√£o: Sem Budget', icon: 'piggy-bank', color: 'amber', emoji: 'üìâ', desc: 'N√£o temos verba', prompt: 'Como lidar com "N√£o temos budget aprovado para este ano"?' },
            { id: 'close_techniques', modules: ['closer'], name: 'T√©cnicas de Fechamento', icon: 'check-circle', color: 'green', emoji: 'ü§ù', desc: 'Assumptivo/Alternativo', prompt: 'Sugira 3 t√©cnicas de fechamento (Assumptivo, Ou-Ou, Urg√™ncia) para este deal.' },
            { id: 'close_negotiation', modules: ['closer'], name: 'Script de Negocia√ß√£o', icon: 'briefcase', color: 'slate', emoji: 'üíº', desc: 'Negociar Termos', prompt: 'Crie um roteiro para negociar termos contratuais mantendo a margem de lucro.' },
            { id: 'close_roi_calc', modules: ['closer'], name: 'Calculadora de ROI', icon: 'bar-chart-2', color: 'blue', emoji: 'üìä', desc: 'Pitch de ROI', prompt: 'Escreva um pitch l√≥gico demonstrando o ROI (Retorno sobre Investimento) da solu√ß√£o.' },
            { id: 'close_urgency', modules: ['closer'], name: 'Criar Urg√™ncia', icon: 'clock', color: 'red', emoji: '‚è∞', desc: 'Gatilhos de Urg√™ncia', prompt: 'Escreva 3 argumentos √©ticos para criar urg√™ncia genu√≠na no fechamento.' },
            { id: 'social_bio', modules: ['bdr'], name: 'Bio Otimizada', icon: 'user', color: 'indigo', emoji: 'ü§≥', desc: 'Bio do LinkedIn', prompt: 'Reescreva esta Bio do LinkedIn para focar em como eu ajudo meus clientes (Customer Centric).' },
            { id: 'social_comment', modules: ['bdr'], name: 'Coment√°rio Estrat√©gico', icon: 'message-square', color: 'cyan', emoji: 'üí¨', desc: 'Comentar Posts', prompt: 'Escreva um coment√°rio perspicaz para um post de um lead sobre [TEMA] que gere autoridade.' },
            { id: 'social_article', modules: ['bdr'], name: 'Ideias de Artigos', icon: 'file-text', color: 'pink', emoji: 'üì∞', desc: 'Pauta de Conte√∫do', prompt: 'Gere 5 ideias de artigos para LinkedIn focados nas dores do meu ICP.' },
            { id: 'lead_oneonone', modules: ['leader'], name: 'Pauta 1:1', icon: 'users', color: 'purple', emoji: 'üó£Ô∏è', desc: 'Reuni√£o Individual', prompt: 'Crie uma pauta para reuni√£o 1:1 com um SDR focada em desenvolvimento e m√©tricas.' },
            { id: 'lead_pipeline', modules: ['leader'], name: 'Pipeline Review', icon: 'layers', color: 'blue', emoji: 'üìë', desc: 'Revis√£o de Funil', prompt: 'Quais perguntas um gerente deve fazer ao revisar o pipeline de um vendedor para garantir forecast preciso?' },
            { id: 'lead_hiring', modules: ['leader'], name: 'Perguntas de Contrata√ß√£o', icon: 'user-plus', color: 'green', emoji: '‚ûï', desc: 'Entrevista de Vendas', prompt: 'Liste 10 perguntas comportamentais para entrevistar um candidato a Closer (Account Executive).' },
            { id: 'lead_culture', modules: ['leader'], name: 'Cultura de Vendas', icon: 'heart', color: 'red', emoji: 'üî•', desc: 'Motiva√ß√£o de Time', prompt: 'Ideias para criar rituais e competi√ß√µes saud√°veis para motivar o time de vendas.' },
            { id: 'cs_onboarding', modules: ['hub'], name: 'Email de Boas-vindas', icon: 'sun', color: 'yellow', emoji: 'üëã', desc: 'Onboarding Cliente', prompt: 'Escreva um email de boas-vindas caloroso explicando os pr√≥ximos passos do onboarding.' },
            { id: 'cs_upsell', modules: ['hub', 'closer'], name: 'Script de Upsell', icon: 'trending-up', color: 'emerald', emoji: 'üìà', desc: 'Expandir Conta', prompt: 'Como oferecer um upgrade de plano para um cliente satisfeito? Crie um script.' },
            { id: 'cs_churn', modules: ['hub'], name: 'Revers√£o de Churn', icon: 'alert-octagon', color: 'red', emoji: 'üõë', desc: 'Evitar Cancelamento', prompt: 'Script para tentar reverter um cliente que pediu cancelamento.' }];

        // LOGIC
        function goHome() {
            showView('hub');
            currentModule = 'hub';
            updateTheme('hub');
        }

        function selectModule(mode) {
            currentModule = mode;
            showView('grid');
            renderGrid(mode);
            updateTheme(mode);
        }

        function updateTheme(mode) {
            const themes = {
                hub: { text: 'Sales OS', color: 'indigo' },
                bdr: { text: 'BDR Intel', color: 'indigo' },
                sdr: { text: 'SDR Hunter', color: 'rose' },
                closer: { text: 'Closer Elite', color: 'amber' }
            };

            const badge = document.getElementById('module-badge');
            const sub = document.getElementById('header-sub');
            const logo = document.getElementById('header-logo-bg');
            const chatMode = document.getElementById('chat-mode-text');
            const chatHeader = document.getElementById('chat-header');

            if(badge) badge.innerText = themes[mode].text;
            if(sub) sub.innerText = themes[mode].text;
            if(chatMode) chatMode.innerText = themes[mode].text;

            let grad = 'from-brand-primary to-purple-600';
            let chatGrad = 'from-brand-primary to-indigo-600';

            if (mode === 'sdr') { grad = 'from-rose-500 to-orange-600'; chatGrad = 'from-rose-500 to-orange-600'; }
            if (mode === 'closer') { grad = 'from-amber-500 to-yellow-600'; chatGrad = 'from-amber-500 to-yellow-600'; }

            if(logo) logo.className = `w-10 h-10 bg-gradient-to-br ${grad} rounded-full flex items-center justify-center shadow-lg group-hover:rotate-12 transition-transform duration-300`;
            if(chatHeader) chatHeader.className = `p-4 bg-gradient-to-r ${chatGrad} text-white flex justify-between items-center`;
        }

                function renderGrid(mode) {
            const grid = document.getElementById('tool-grid');
            const searchInput = document.getElementById('tool-search');
            const term = searchInput ? searchInput.value.toLowerCase() : '';

            let filtered = masterTools.filter(t => t.modules.includes(mode));

            // Favorites Filter (Optional - could add a toggle later)
            // For now just render icons.

            const favs = JSON.parse(localStorage.getItem('bh_favorites') || '[]');

            if (term) {
                filtered = filtered.filter(t =>
                    t.name.toLowerCase().includes(term) ||
                    t.desc.toLowerCase().includes(term)
                );
            }

            grid.innerHTML = filtered.map((t, index) => {
                const isFav = favs.includes(t.id);
                const starClass = isFav ? "fill-yellow-400 text-yellow-400" : "text-slate-400 hover:text-yellow-400";

                return `
                <div onclick="openTool('${t.id}')" class="tool-card relative p-2.5 rounded-xl glass cursor-pointer group overflow-hidden hover:bg-white/5 transition-colors border border-transparent hover:border-${t.color}-500/20 shadow-sm hover:shadow-md" style="animation-delay: ${index * 0.05}s">
                    <button onclick="event.stopPropagation(); toggleFavorite('${t.id}')" class="absolute top-2 right-2 z-20 p-1.5 rounded-full hover:bg-white/10 transition-colors group/star">
                        <i data-lucide="star" class="w-3.5 h-3.5 ${starClass} transition-colors"></i>
                    </button>

                    <div class="absolute -right-3 -bottom-3 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 duration-500 pointer-events-none">
                        <i data-lucide="${t.icon}" class="w-12 h-12 text-${t.color}-500"></i>
                    </div>

                    <div class="flex items-start gap-2 relative z-10">
                        <div class="w-8 h-8 rounded-lg bg-${t.color}-500/10 text-${t.color}-500 flex items-center justify-center group-hover:scale-110 transition-transform flex-shrink-0">
                            <span class="text-base">${t.emoji}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-[11px] font-black uppercase tracking-tight leading-tight mb-0.5 text-slate-700 dark:text-slate-200 group-hover:text-white transition-colors truncate">${t.name}</h3>
                            <p class="text-[9px] font-medium text-slate-500 dark:text-slate-400 line-clamp-2 leading-3 h-6">${t.desc}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');

            lucide.createIcons();
        }

        function toggleFavorite(id) {
            const favs = JSON.parse(localStorage.getItem('bh_favorites') || '[]');
            if (favs.includes(id)) {
                const idx = favs.indexOf(id);
                favs.splice(idx, 1);
            } else {
                favs.push(id);
            }
            localStorage.setItem('bh_favorites', JSON.stringify(favs));
            // Re-render only if we are in grid view? Yes.
            // We need to know current module. 'currentModule' is global.
            renderGrid(currentModule);
        }


        function showView(id) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
            const target = document.getElementById(`view-${id}`);
            if (target) {
                target.classList.add('view-active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function closeTool() {
            showView('grid');
        }

        function openTool(id) {
            const tool = masterTools.find(t => t.id === id);
            const container = document.getElementById('tool-container');

            if (tool.type === 'widget') {
                renderWidget(container, tool);
                lucide.createIcons();
                showView('tool');
                return;
            }

            if(tool.isChat) {
                roleplayHistory[id] = [];
                renderChatInterface(container, tool);
            } else {
                renderStandardInterface(container, tool);
            }
            lucide.createIcons();
            showView('tool');
        }



        function escapeHtml(text) {
            if (!text) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showError(title, msg) {
            const modal = document.getElementById('error-modal');
            document.getElementById('error-title').innerText = title;
            document.getElementById('error-msg').innerText = msg;

            modal.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeError() {
            const modal = document.getElementById('error-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }


        function exportHistoryCSV() {
            try {
                // Get all history keys
                // Actually roleplayHistory is in memory.
                // But we want to export persistent history if we have it.
                // The history viewer used Firestore? Or local roleplayHistory?
                // The prompt says "Hist√≥rico Viewer (Firestore integration)".
                // So history is in Firestore.
                // We can't easily export ALL Firestore data without fetching it.
                // But loadHistory() fetches it.
                // Let's assume we export what is currently loaded or we fetch it.

                // For simplicity, let's export the `roleplayHistory` object (session history) AND maybe trigger a fetch for Firestore.
                // "roleplayHistory" var tracks session.

                // Let's implement a simple export of the `roleplayHistory` global var for now,
                // OR better, export the data displayed in the "History" view if possible.
                // The history view populates `#history-list`.

                // Let's create a CSV from `roleplayHistory` global first.

                const rows = [['Tool ID', 'Timestamp', 'User', 'Assistant']];

                Object.keys(roleplayHistory).forEach(toolId => {
                    roleplayHistory[toolId].forEach(msg => {
                        rows.push([toolId, new Date().toISOString(), msg.role, `"${msg.content.replace(/"/g, '""')}"`]);
                    });
                });

                let csvContent = "data:text/csv;charset=utf-8,"
                    + rows.map(e => e.join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "sales_os_history.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch(e) {
                showError('Erro no Export', e.message);
            }
        }

        // --- WIDGET LOGIC ---
                function renderWidget(container, tool) {
            let content = '';

            if (tool.widgetType === 'scratchpad') {
                const saved = localStorage.getItem('bh_scratchpad') || '';
                content = `
                    <div class="flex flex-col h-full">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                            <i data-lucide="${tool.icon}" class="text-${tool.color}-500"></i> ${tool.name}
                        </h2>
                        <textarea id="scratchpad-area" class="flex-1 w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl p-4 text-sm outline-none focus:border-indigo-500 resize-none font-mono text-slate-800 dark:text-slate-300 mb-4" placeholder="Digite suas notas aqui...">${escapeHtml(saved)}</textarea>
                        <div class="flex justify-end">
                            <button onclick="saveScratchpad()" class="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-xs font-bold text-white transition-all shadow-lg hover:shadow-indigo-500/25">SALVAR NOTAS</button>
                        </div>
                    </div>`;
            }
            else if (tool.widgetType === 'goals') { content = renderGoalTracker(); }
            else if (tool.widgetType === 'calculator') { content = renderCalculator(); }
            else if (tool.widgetType === 'pomodoro') { content = renderPomodoro(); }
            else if (tool.widgetType === 'worldclock') { content = renderWorldClock(); }
            else if (tool.widgetType === 'counter') { content = renderObjectionCounter(); }
            else if (tool.widgetType === 'links') { content = renderQuickLinks(); }
            else if (tool.widgetType === 'affirmation') { content = renderAffirmation(); }

            container.innerHTML = `
                <div class="bg-white dark:bg-[#1a1b26] border border-slate-200 dark:border-white/5 rounded-[2rem] p-6 md:p-8 shadow-2xl h-full flex flex-col relative overflow-hidden animate-in fade-in zoom-in duration-300">
                    <button onclick="closeTool()" class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-white/5 text-slate-400 hover:text-red-400 transition-colors z-10">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                    ${content}
                </div>`;

            // Post-render init
            if(tool.widgetType === 'goals') refreshGoalList();
            if(tool.widgetType === 'worldclock') startWorldClock();
            if(tool.widgetType === 'counter') refreshObjections();
            if(tool.widgetType === 'links') refreshLinks();
        }

        function saveScratchpad() {
            const val = document.getElementById('scratchpad-area').value;
            localStorage.setItem('bh_scratchpad', val);
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'SALVO!';
            btn.classList.add('bg-green-500');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-green-500');
            }, 1500);
        }

        // -- GOAL TRACKER --
        function renderGoalTracker() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="target" class="text-emerald-500"></i> Metas
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="goal-input" placeholder="Nova meta..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-emerald-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addGoal()">
                        <button onclick="addGoal()" class="p-2 bg-emerald-500 hover:bg-emerald-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="goal-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                        <!-- Goals rendered here -->
                    </div>
                </div>`;
        }

        function getGoals() {
            return JSON.parse(localStorage.getItem('bh_goals') || '[]');
        }

        function addGoal() {
            const input = document.getElementById('goal-input');
            const text = input.value.trim();
            if(!text) return;

            const goals = getGoals();
            goals.push({ id: Date.now(), text, done: false });
            localStorage.setItem('bh_goals', JSON.stringify(goals));
            input.value = '';
            refreshGoalList();
        }

        function toggleGoal(id) {
            const goals = getGoals();
            const idx = goals.findIndex(g => g.id === id);
            if(idx > -1) {
                goals[idx].done = !goals[idx].done;
                localStorage.setItem('bh_goals', JSON.stringify(goals));
                refreshGoalList();
            }
        }

        function deleteGoal(id) {
            let goals = getGoals();
            goals = goals.filter(g => g.id !== id);
            localStorage.setItem('bh_goals', JSON.stringify(goals));
            refreshGoalList();
        }

        function refreshGoalList() {
            const list = document.getElementById('goal-list');
            if(!list) return;
            const goals = getGoals();

            if(goals.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-400 text-sm mt-10">Nenhuma meta definida.</p>';
                return;
            }

            list.innerHTML = goals.map(g => `
                <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 dark:border-white/5 ${g.done ? 'bg-emerald-500/10 opacity-60' : 'bg-slate-50 dark:bg-white/5'} transition-all group">
                    <button onclick="toggleGoal(${g.id})" class="w-5 h-5 rounded border ${g.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-400'} flex items-center justify-center transition-all">
                        ${g.done ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                    </button>
                    <span class="flex-1 text-sm ${g.done ? 'line-through text-slate-500' : 'text-slate-700 dark:text-slate-200'}">${escapeHtml(g.text)}</span>
                    <button onclick="deleteGoal(${g.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // -- CALCULATOR --
        function renderCalculator() {
            return `
                <div class="flex flex-col h-full max-w-sm mx-auto w-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="calculator" class="text-orange-500"></i> Calculadora
                    </h2>
                    <div class="bg-slate-100 dark:bg-black/30 rounded-2xl p-4 mb-4 text-right">
                        <div id="calc-display" class="text-3xl font-mono text-slate-800 dark:text-white font-bold truncate">0</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 flex-1">
                        <button onclick="calcInput('C')" class="col-span-1 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-xl font-bold transition-all">C</button>
                        <button onclick="calcInput('(')" class="bg-slate-200 dark:bg-white/5 hover:bg-white/10 rounded-xl font-bold dark:text-white text-slate-700">((</button>
                        <button onclick="calcInput(')')" class="bg-slate-200 dark:bg-white/5 hover:bg-white/10 rounded-xl font-bold dark:text-white text-slate-700">)</button>
                        <button onclick="calcInput('/')" class="bg-orange-500/10 text-orange-500 hover:bg-orange-500 hover:text-white rounded-xl font-bold">√∑</button>

                        <button onclick="calcInput('7')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">7</button>
                        <button onclick="calcInput('8')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">8</button>
                        <button onclick="calcInput('9')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">9</button>
                        <button onclick="calcInput('*')" class="bg-orange-500/10 text-orange-500 hover:bg-orange-500 hover:text-white rounded-xl font-bold">√ó</button>

                        <button onclick="calcInput('4')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">4</button>
                        <button onclick="calcInput('5')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">5</button>
                        <button onclick="calcInput('6')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">6</button>
                        <button onclick="calcInput('-')" class="bg-orange-500/10 text-orange-500 hover:bg-orange-500 hover:text-white rounded-xl font-bold">-</button>

                        <button onclick="calcInput('1')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">1</button>
                        <button onclick="calcInput('2')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">2</button>
                        <button onclick="calcInput('3')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">3</button>
                        <button onclick="calcInput('+')" class="bg-orange-500/10 text-orange-500 hover:bg-orange-500 hover:text-white rounded-xl font-bold">+</button>

                        <button onclick="calcInput('0')" class="col-span-2 bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">0</button>
                        <button onclick="calcInput('.')" class="bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 rounded-xl font-bold text-lg dark:text-white text-slate-700 shadow-sm">.</button>
                        <button onclick="calcResult()" class="bg-orange-500 text-white hover:bg-orange-600 rounded-xl font-bold shadow-lg shadow-orange-500/25">=</button>
                    </div>
                </div>`;
        }

        let calcExpr = '';
        function calcInput(val) {
            if(val === 'C') {
                calcExpr = '';
            } else {
                calcExpr += val;
            }
            document.getElementById('calc-display').innerText = calcExpr || '0';
        }
        function calcResult() {
            try {
                // simple safe eval replacement or just eval for local tool
                // Using Function to avoid direct eval scope issues, though similar risk.
                // For a simple calculator tool in a sandbox, eval is acceptable if input is controlled.
                // But let's sanitise.
                const safeExpr = calcExpr.replace(/[^0-9+\-*/().]/g, '');
                const res = new Function('return ' + safeExpr)();
                calcExpr = String(res);
                document.getElementById('calc-display').innerText = calcExpr;
            } catch(e) {
                document.getElementById('calc-display').innerText = 'Err';
                calcExpr = '';
            }
        }

function renderStandardInterface(container, tool) {
            const showUpload = tool.acceptsImage ? '' : 'hidden';

            // Build Dynamic Fields
            let fieldsHTML = '';
            if (tool.fields) {
                fieldsHTML = tool.fields.map(field => {
                    if (field.type === 'select') {
                        const options = field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                        return `
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-2">${field.label}</label>
                                <select id="field-${field.id}" class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2.5 text-xs font-medium outline-none focus:border-${tool.color}-500/50 dark:text-white text-slate-800 appearance-none">
                                    ${options}
                                </select>
                            </div>`;
                    } else if (field.type === 'textarea') {
                        return `
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-2">${field.label}</label>
                                <textarea id="field-${field.id}" placeholder="${field.placeholder}" class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-xs font-medium outline-none h-24 focus:border-${tool.color}-500/50 dark:text-white text-slate-800 resize-none"></textarea>
                            </div>`;
                    } else {
                        return `
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-2">${field.label}</label>
                                <input type="text" id="field-${field.id}" placeholder="${field.placeholder}" class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2.5 text-xs font-medium outline-none focus:border-${tool.color}-500/50 dark:text-white text-slate-800">
                            </div>`;
                    }
                }).join('');
            } else {
                // Fallback generic field
                fieldsHTML = `
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-3">Contexto</label>
                        <textarea id="t-input" placeholder="Insira o contexto aqui..." class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-xs font-medium outline-none h-32 focus:border-${tool.color}-500/50 dark:text-white text-slate-800 resize-none"></textarea>
                    </div>`;
            }

            container.innerHTML = `
                <!-- INPUT -->
                <div class="lg:col-span-5 flex flex-col gap-5 h-full">
                    <div class="glass p-6 rounded-[2.5rem] shadow-2xl animate-[popIn_0.4s_ease-out] flex flex-col h-full">
                        <div class="flex items-center justify-between mb-6 shrink-0">
                            <button onclick="showView('grid')" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-white/10 flex items-center justify-center hover:bg-white hover:text-brand-primary transition-all dark:text-white text-slate-900 shadow-md">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </button>
                            <div class="flex items-center gap-2 bg-${tool.color}-500/10 px-3 py-1.5 rounded-full border border-${tool.color}-500/20">
                                <i data-lucide="${tool.icon}" class="w-3.5 h-3.5 text-${tool.color}-500"></i>
                                <h3 class="text-[10px] font-black uppercase text-${tool.color}-500 tracking-widest">${tool.name}</h3>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4">
                            ${fieldsHTML}

                            <div class="${showUpload} mt-2">
                                <label class="flex items-center gap-2 cursor-pointer w-full justify-center px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-dashed border-white/20 transition-all hover:border-${tool.color}-500/50">
                                    <i data-lucide="image-plus" class="w-4 h-4 text-${tool.color}-400"></i>
                                    <span class="text-[10px] font-bold text-slate-300 uppercase">Carregar Imagem</span>
                                    <input type="file" id="t-file" accept="image/*" class="hidden" onchange="showToast('Imagem Carregada! üì∏')">
                                </label>
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t border-white/5 shrink-0">
                            <button onclick="runIA('${tool.id}')" id="exec-btn" class="w-full py-3.5 bg-gradient-to-r from-${tool.color}-500 to-${tool.color}-600 rounded-xl text-xs font-black uppercase tracking-[0.2em] flex items-center justify-center gap-2 text-white shadow-lg shadow-${tool.color}-500/30 hover:scale-[1.02] active:scale-[0.98] transition-all group overflow-hidden relative">
                                <span class="relative z-10">Gerar Estrat√©gia</span>
                                <i data-lucide="zap" class="w-4 h-4 relative z-10 group-hover:rotate-12 transition-transform"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- OUTPUT -->
                <div class="lg:col-span-7 flex flex-col h-full min-h-[500px]">
                    <div class="glass flex-1 p-6 md:p-8 rounded-[2.5rem] shadow-2xl relative flex flex-col border border-white/10 animate-[popIn_0.6s_ease-out]">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">
                                <div class="w-2.5 h-2.5 rounded-full bg-${tool.color}-500 animate-pulse shadow-[0_0_10px_currentColor]"></div>
                                <span class="text-[9px] font-black uppercase text-slate-400 tracking-[0.2em]">Resultado Gemini Pro</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="sendToCRM()" class="w-8 h-8 rounded-full glass flex items-center justify-center hover:bg-blue-500 hover:text-white hover:border-blue-400 transition-all text-slate-400" title="Enviar p/ CRM">
                                    <i data-lucide="webhook" class="w-3.5 h-3.5"></i>
                                </button>
                                <button onclick="exportPDF('${tool.name}')" class="w-8 h-8 rounded-full glass flex items-center justify-center hover:bg-red-500 hover:text-white hover:border-red-400 transition-all text-slate-400" title="PDF">
                                    <i data-lucide="file-down" class="w-3.5 h-3.5"></i>
                                </button>
                                <button onclick="saveResult('${tool.name}')" class="w-8 h-8 rounded-full glass flex items-center justify-center hover:bg-green-500 hover:text-white hover:border-green-400 transition-all text-slate-400" title="Salvar">
                                    <i data-lucide="save" class="w-3.5 h-3.5"></i>
                                </button>
                                <button onclick="copyRes()" class="w-8 h-8 rounded-full bg-brand-primary text-white flex items-center justify-center hover:bg-indigo-400 shadow-lg shadow-brand-primary/30 transition-all active:scale-90" title="Copiar">
                                    <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </div>

                        <div id="t-output" class="flex-1 text-sm leading-relaxed dark:text-slate-200 text-slate-700 custom-scrollbar overflow-y-auto whitespace-pre-wrap font-medium p-1 relative">
                            <div class="h-full flex flex-col items-center justify-center opacity-30 text-center space-y-4">
                                <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center">
                                    <i data-lucide="cpu" class="w-8 h-8"></i>
                                </div>
                                <p class="uppercase tracking-[0.3em] font-black text-[10px]">Aguardando Dados...</p>
                            </div>
                        </div>

                        <!-- Magic Actions -->
                        <div id="magic-actions" class="mt-4 pt-4 border-t border-white/5 flex gap-2 hidden">
                            <button onclick="refineOutput('shorter')" class="flex-1 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-[9px] font-bold uppercase tracking-widest flex items-center justify-center gap-2 transition-colors"><i data-lucide="scissors" class="w-3 h-3"></i> Encurtar</button>
                            <button onclick="refineOutput('formal')" class="flex-1 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-[9px] font-bold uppercase tracking-widest flex items-center justify-center gap-2 transition-colors"><i data-lucide="briefcase" class="w-3 h-3"></i> Formal</button>
                            <button onclick="refineOutput('english')" class="flex-1 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-[9px] font-bold uppercase tracking-widest flex items-center justify-center gap-2 transition-colors"><i data-lucide="languages" class="w-3 h-3"></i> English</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChatInterface(container, tool) {
            container.innerHTML = `
                <div class="col-span-12 h-[70vh] flex flex-col glass rounded-[2.5rem] overflow-hidden shadow-2xl relative">
                    <!-- Header -->
                    <div class="p-6 bg-gradient-to-r from-${tool.color}-600 to-${tool.color}-800 flex justify-between items-center text-white shrink-0">
                        <div class="flex items-center gap-4">
                            <button onclick="showView('grid')" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center hover:bg-white hover:text-${tool.color}-600 transition-colors">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </button>
                            <div>
                                <h3 class="font-black text-sm uppercase tracking-wide flex items-center gap-2">
                                    ${tool.name} <span class="bg-white/20 text-[9px] px-2 py-0.5 rounded-full">SIMULA√á√ÉO GEMINI</span>
                                </h3>
                                <p class="text-[10px] opacity-80">${tool.desc}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div id="roleplay-messages" class="flex-1 p-6 overflow-y-auto space-y-4 custom-scrollbar bg-slate-900/50">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-${tool.color}-500 flex-shrink-0 flex items-center justify-center text-white text-xs font-bold shadow-lg">${tool.emoji}</div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none shadow-md text-sm leading-relaxed text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 max-w-[80%]">
                                ${tool.firstMsg}
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="p-4 bg-slate-100 dark:bg-slate-900/80 border-t border-white/5 flex gap-3 items-center shrink-0">
                        <button onclick="startRoleplayVoice()" class="w-12 h-12 rounded-full bg-rose-500 hover:bg-rose-600 text-white flex items-center justify-center shadow-lg transition-transform active:scale-95 group">
                            <i data-lucide="mic" class="w-5 h-5 group-hover:animate-pulse"></i>
                        </button>
                        <input id="roleplay-input" type="text" placeholder="Responda como se estivesse na chamada..." class="flex-1 bg-white dark:bg-black/20 rounded-full px-6 py-3 text-xs outline-none focus:ring-2 focus:ring-${tool.color}-500/50 transition-all dark:text-white text-slate-900 shadow-inner">
                        <button onclick="sendRoleplayMessage('${tool.id}')" class="w-12 h-12 rounded-full bg-${tool.color}-500 hover:bg-${tool.color}-600 text-white flex items-center justify-center shadow-lg transition-transform active:scale-95">
                            <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                        </button>
                    </div>
                </div>
            `;
            speakResult(tool.firstMsg);
        }

        async function refineOutput(action) {
            const output = document.getElementById('t-output');
            const currentText = output.innerText;
            if(!currentText || currentText.includes("Aguardando")) return;

            output.innerHTML = `<div class="flex items-center justify-center h-full opacity-50"><div class="loader-spinner"></div></div>`;

            let prompt = "";
            if (action === 'shorter') prompt = "Resuma o texto abaixo mantendo os pontos chave. Seja extremamente conciso e direto ao ponto:";
            if (action === 'formal') prompt = "Reescreva o texto abaixo com um tom executivo, formal e altamente profissional:";
            if (action === 'english') prompt = "Translate the following text to professional Business English:";

            try {
                const res = await fetchWithRetry(endpoints.text, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `${prompt}\n\n${currentText}` }] }] })
                });
                output.innerText = res.candidates?.[0]?.content?.parts?.[0]?.text || currentText;
            } catch (e) { output.innerText = currentText; }
        }

        async function runIA(id) {
            const tool = masterTools.find(t => t.id === id);
            const output = document.getElementById('t-output');
            const btn = document.getElementById('exec-btn');
            const magicActions = document.getElementById('magic-actions');
            const fileInput = document.getElementById('t-file');

            // Collect Form Data
            let collectedData = "";
            let isEmpty = true;

            if (tool.fields) {
                const parts = [];
                tool.fields.forEach(field => {
                    const el = document.getElementById(`field-${field.id}`);
                    if (el && el.value) {
                        parts.push(`${field.label}: ${el.value}`);
                        isEmpty = false;
                    }
                });
                collectedData = parts.join('\n');
            } else {
                // Fallback for simple input
                const simpleInput = document.getElementById('t-input');
                if (simpleInput && simpleInput.value) {
                    collectedData = simpleInput.value;
                    isEmpty = false;
                }
            }

            if(isEmpty && (!fileInput || !fileInput.files.length) && !tool.isImage) return;

            if(magicActions) magicActions.classList.add('hidden');
            btn.disabled = true;
            const originalBtn = btn.innerHTML;
            btn.innerHTML = `<div class="loader-spinner"></div>`;

            output.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center gap-4 animate-pulse">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-full border-4 border-slate-200 dark:border-slate-700 border-t-brand-primary animate-spin"></div>
                    </div>
                    <span class="text-[10px] font-black uppercase tracking-[0.3em] text-brand-primary">Processando...</span>
                </div>`;

            try {
                if (tool.isImage) {
                    // Generative Image (Imagen)
                    const result = await fetchWithRetry(endpoints.image, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: { prompt: `${tool.prompt} Detalhes: ${collectedData}. Cinematic lighting, 8k.` },
                            parameters: { sampleCount: 1 }
                        })
                    });
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    output.innerHTML = `<img src="${imageUrl}" class="w-full rounded-[2rem] shadow-2xl border-4 border-white/10" alt="Generated Image">`;
                } else {
                    // Text Generation (Gemini 2.5) with Multimodal support
                    const parts = [{ text: `Voc√™ √© uma IA de elite especializada em vendas (${currentModule.toUpperCase()}).

                    INSTRU√á√ïES MESTRAS:
                    1. Aja como um especialista s√™nior.
                    2. Seja direto, evite "fluff" ou introdu√ß√µes longas.
                    3. Use formata√ß√£o Markdown (negrito, listas) para legibilidade.
                    4. ${tool.prompt}

                    DADOS DE ENTRADA:
                    ${collectedData}

                    Resposta:` }];

                    if (tool.acceptsImage && fileInput && fileInput.files.length > 0) {
                        const base64Data = await fileToGenerativePart(fileInput.files[0]);
                        parts.push(base64Data);
                    }

                    const payload = {
                        contents: [{ parts: parts }],
                        generationConfig: { temperature: 0.7 }
                    };
                    if (tool.useSearch) payload.tools = [{ "google_search": {} }];

                    const result = await fetchWithRetry(endpoints.text, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erro de processamento.";
                    output.innerText = text;
                    if(magicActions) magicActions.classList.remove('hidden');

                    if (id.includes('coldcall') || id.includes('reverser')) speakResult(text);
                }
            } catch (e) {
                console.error(e);
                output.innerHTML = `<div class="text-rose-500 font-bold text-center">Falha na conex√£o neural. Tente novamente.</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtn;
            }
        }

        async function sendRoleplayMessage(toolId) {
            const tool = masterTools.find(t => t.id === toolId);
            const input = document.getElementById('roleplay-input');
            const msgs = document.getElementById('roleplay-messages');
            if(!input.value) return;

            const userText = input.value;
            input.value = '';

            // User Bubble
            msgs.innerHTML += `
                <div class="flex gap-3 flex-row-reverse animate-[popIn_0.3s_ease-out]">
                    <div class="w-8 h-8 rounded-full bg-slate-300 dark:bg-slate-700 flex-shrink-0 flex items-center justify-center text-[10px] font-bold">EU</div>
                    <div class="bg-brand-primary p-4 rounded-2xl rounded-tr-none shadow-md text-sm leading-relaxed text-white max-w-[80%]">
                        ${userText}
                    </div>
                </div>
            `;
            msgs.scrollTop = msgs.scrollHeight;

            if (!roleplayHistory[toolId]) roleplayHistory[toolId] = [];

            const historyPrompt = roleplayHistory[toolId].map(m => `${m.role}: ${m.text}`).join('\n');
            const fullPrompt = `Roleplay Context: Voc√™ √© ${tool.persona}.\nHist√≥rico da conversa:\n${historyPrompt}\nO usu√°rio (Vendedor) disse: "${userText}".\nResponda como a persona. Seja curto (m√°x 3 frases). Mantenha a personagem dif√≠cil.`;

            try {
                const res = await fetchWithRetry(endpoints.text, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });
                const aiText = res.candidates?.[0]?.content?.parts?.[0]?.text;

                roleplayHistory[toolId].push({ role: 'Vendedor', text: userText });
                roleplayHistory[toolId].push({ role: 'Persona', text: aiText });

                msgs.innerHTML += `
                    <div class="flex gap-3 animate-[popIn_0.3s_ease-out]">
                        <div class="w-8 h-8 rounded-full bg-${tool.color}-500 flex-shrink-0 flex items-center justify-center text-white text-xs font-bold shadow-lg">${tool.emoji}</div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none shadow-md text-sm leading-relaxed text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 max-w-[80%]">
                            ${aiText}
                        </div>
                    </div>
                `;
                msgs.scrollTop = msgs.scrollHeight;
                speakResult(aiText);
            } catch(e) {}
        }

        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        async function fetchWithRetry(url, options, maxRetries = 3) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                } catch (err) {}
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
            throw new Error('Falha API');
        }

        async function speakResult(text) {
            try {
                const response = await fetch(endpoints.tts, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text.substring(0, 400) }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } },
                        model: "gemini-2.5-flash-preview-tts"
                    })
                });
                const result = await response.json();
                const pcmData = result.candidates[0].content.parts[0].inlineData.data;
                const wavBuffer = pcmToWav(pcmData);
                new Audio(URL.createObjectURL(new Blob([wavBuffer], { type: 'audio/wav' }))).play();
            } catch (e) {}
        }

        function pcmToWav(pcmBase64) {
            const pcm = atob(pcmBase64);
            const buffer = new ArrayBuffer(44 + pcm.length);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + pcm.length, true); writeString(8, 'WAVE');
            writeString(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, 24000, true); view.setUint32(28, 48000, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, pcm.length, true);
            for (let i = 0; i < pcm.length; i++) view.setUint8(44 + i, pcm.charCodeAt(i));
            return buffer;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msgs = document.getElementById('chat-messages');
            if(!input.value) return;
            const text = input.value;
            msgs.innerHTML += `<div class="bg-brand-primary p-4 rounded-2xl rounded-tr-none shadow-md text-xs leading-relaxed text-white ml-auto max-w-[80%]">${text}</div>`;
            input.value = "";
            msgs.scrollTop = msgs.scrollHeight;

            try {
                const res = await fetchWithRetry(endpoints.text, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Aja como um Mentor ${currentModule.toUpperCase()}. Responda curto: ${text}` }] }] })
                });
                const ai = res.candidates?.[0]?.content?.parts?.[0]?.text;
                msgs.innerHTML += `<div class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none shadow-sm text-xs leading-relaxed text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 max-w-[90%]">${ai}</div>`;
                msgs.scrollTop = msgs.scrollHeight;
            } catch(e) {}
        }

        function saveResult(name) {
            const content = document.getElementById('t-output').innerText;
            if(window.saveToHistory) window.saveToHistory(name, content, currentModule);
        }

        async function sendToCRM() {
            const content = document.getElementById('t-output').innerText;
            if (!content || content.includes("Aguardando")) return showToast("Nada para enviar!");
            if (!window.crmUrl) return showToast("Configure o Webhook!");

            try {
                await fetch(window.crmUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        module: currentModule,
                        operator: window.userName,
                        timestamp: new Date().toISOString(),
                        content: content
                    })
                });
                showToast("ENVIADO AO CRM! üöÄ");
            } catch (e) {
                console.error(e);
                showToast("Erro no envio.");
            }
        }

        function exportPDF(name) {
            const element = document.getElementById('t-output');
            if (!element.innerText || element.innerText.includes("Aguardando")) return showToast("Nada para exportar!");

            const opt = {
              margin:       10,
              filename:     `BirthHub-${name}-${Date.now()}.pdf`,
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 2 },
              jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
            showToast("Gerando PDF... üìÑ");
        }

        function copyRes() {
            navigator.clipboard.writeText(document.getElementById('t-output').innerText);
            showToast("COPIADO! üìã");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast-msg');
            toast.querySelector('span').innerText = msg;
            toast.style.opacity = '1';
            toast.style.transform = 'translate(-50%, 0)';
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translate(-50%, 40px)'; }, 2500);
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            document.getElementById('theme-icon').setAttribute('data-lucide', isDark ? 'moon' : 'sun');
            localStorage.setItem('bh_theme', isDark ? 'dark' : 'light');
            lucide.createIcons();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function toggleChat() {
            document.getElementById('chat-window').classList.toggle('hidden');
        }

        function updateClock() {
            const now = new Date();
            const timeEl = document.getElementById('header-time');
            const dateEl = document.getElementById('header-date');
            if (timeEl) timeEl.innerText = now.toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'});
            if (dateEl) dateEl.innerText = now.toLocaleDateString('pt-PT');
        }

        function startGlobalVoice() {
            if (!('webkitSpeechRecognition' in window)) return showToast("Sem suporte a voz.");
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'pt-BR';
            const btn = document.getElementById('voice-btn');
            btn.classList.add('animate-pulse', 'border-white');
            recognition.onresult = (e) => {
                const active = document.getElementById('t-input') || document.getElementById('chat-input');
                if(active) active.value = e.results[0][0].transcript;
            };
            recognition.onend = () => btn.classList.remove('animate-pulse', 'border-white');
            recognition.start();
        }

        function startRoleplayVoice() {
            if (!('webkitSpeechRecognition' in window)) return showToast("Sem suporte a voz.");
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'pt-BR';
            const btn = document.querySelector('#roleplay-input').previousElementSibling;
            btn.classList.add('animate-pulse', 'bg-red-600');
            recognition.onresult = (e) => {
                const active = document.getElementById('roleplay-input');
                if(active) active.value = e.results[0][0].transcript;
            };
            recognition.onend = () => btn.classList.remove('animate-pulse', 'bg-red-600');
            recognition.start();
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if (isHidden) {
                modal.classList.remove('hidden');
                document.getElementById('set-username').value = window.userName;
                document.getElementById('set-apikey').value = window.apiKey;
                document.getElementById('set-webhook').value = window.crmUrl;
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('div').classList.remove('scale-95');
                });
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            toggleSettings();
        }

        // Init user name
        const greeting = document.getElementById('greeting-text');
        if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);

        // Theme Persistence
        const savedTheme = localStorage.getItem('bh_theme');
        if (savedTheme === 'light') {
            document.documentElement.classList.remove('dark');
            const themeIcon = document.getElementById('theme-icon');
            if(themeIcon) themeIcon.setAttribute('data-lucide', 'sun');
        }

        // Shortcuts
        document.addEventListener('keydown', (e) => {
            // Alt+H: Home
            if (e.altKey && e.key.toLowerCase() === 'h') {
                e.preventDefault();
                goHome();
            }
            // Alt+S: Settings
            if (e.altKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                toggleSettings();
            }
            // Alt+F: Focus Search or Toggle Fullscreen
            if (e.altKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                const search = document.getElementById('tool-search');
                const gridView = document.getElementById('view-grid');
                if (search && gridView && gridView.classList.contains('view-active')) {
                    search.focus();
                } else {
                    toggleFullscreen();
                }
            }
        });

        setInterval(updateClock, 1000);
        updateClock();
        lucide.createIcons();

        // --- NEW WIDGETS LOGIC ---

        // POMODORO
        // DUP let pomodoroInterval;
        // DUP let pomodoroTime = 25 * 60;
        // DUP let isPomodoroRunning = false;

        function renderPomodoro() {
            return `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-bold mb-8 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="clock" class="text-red-500"></i> Pomodoro
                    </h2>
                    <div class="text-7xl font-mono font-bold text-slate-800 dark:text-white mb-8" id="pomo-display">
                        ${formatTime(pomodoroTime)}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="togglePomodoro()" id="pomo-btn" class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-bold text-lg transition-all shadow-lg shadow-red-500/30">
                            INICIAR
                        </button>
                        <button onclick="resetPomodoro()" class="px-6 py-3 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-2xl text-slate-600 dark:text-white font-bold transition-all">
                            RESET
                        </button>
                    </div>
                </div>`;
        }
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (isPomodoroRunning) {
                clearInterval(pomodoroInterval);
                isPomodoroRunning = false;
                btn.innerText = 'CONTINUAR';
                btn.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                isPomodoroRunning = true;
                btn.innerText = 'PAUSAR';
                btn.classList.replace('bg-red-500', 'bg-orange-500');
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    if(pomodoroTime <= 0) {
                        clearInterval(pomodoroInterval);
                        isPomodoroRunning = false;
                        document.getElementById('pomo-display').innerText = "00:00";
                        alert("Pomodoro Finalizado!"); // Simple alert
                        resetPomodoro();
                    } else {
                        document.getElementById('pomo-display').innerText = formatTime(pomodoroTime);
                    }
                }, 1000);
            }
        }
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            pomodoroTime = 25 * 60;
            const display = document.getElementById('pomo-display');
            const btn = document.getElementById('pomo-btn');
            if(display) display.innerText = "25:00";
            if(btn) { btn.innerText = "INICIAR"; btn.classList.remove('bg-orange-500'); btn.classList.add('bg-red-500'); }
        }

        // WORLD CLOCK
        // DUP let worldClockInterval;
        function renderWorldClock() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="globe" class="text-blue-500"></i> Rel√≥gio Mundial
                    </h2>
                    <div id="world-clocks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Clocks -->
                    </div>
                </div>`;
        }
        function startWorldClock() {
            updateWorldClocks();
            if(worldClockInterval) clearInterval(worldClockInterval);
            worldClockInterval = setInterval(updateWorldClocks, 1000);
        }
        function updateWorldClocks() {
            const zones = [
                { label: 'S√£o Paulo', tz: 'America/Sao_Paulo' },
                { label: 'New York', tz: 'America/New_York' },
                { label: 'London', tz: 'Europe/London' },
                { label: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            const container = document.getElementById('world-clocks');
            if(!container) return;

            container.innerHTML = zones.map(z => {
                const time = new Date().toLocaleTimeString('en-US', { timeZone: z.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                const date = new Date().toLocaleDateString('pt-BR', { timeZone: z.tz, day: 'numeric', month: 'short' });
                return `
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${z.label}</span>
                    <span class="text-3xl font-mono font-bold text-slate-800 dark:text-white">${time}</span>
                    <span class="text-[10px] text-slate-500">${date}</span>
                </div>`;
            }).join('');
        }

        // OBJECTION COUNTER
        function renderObjectionCounter() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="trello" class="text-purple-500"></i> Contador de Obje√ß√µes
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="obj-input" placeholder="Nova Obje√ß√£o..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addObjection()">
                        <button onclick="addObjection()" class="p-2 bg-purple-500 hover:bg-purple-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="obj-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getObjections() { return JSON.parse(localStorage.getItem('bh_objections') || '[]'); }
        function addObjection() {
            const input = document.getElementById('obj-input');
            const text = input.value.trim();
            if(!text) return;
            const objs = getObjections();
            objs.push({ id: Date.now(), text, count: 0 });
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            input.value = '';
            refreshObjections();
        }
        function updateObjCount(id, delta) {
            const objs = getObjections();
            const obj = objs.find(o => o.id === id);
            if(obj) {
                obj.count = Math.max(0, obj.count + delta);
                localStorage.setItem('bh_objections', JSON.stringify(objs));
                refreshObjections();
            }
        }
        function deleteObjection(id) {
            let objs = getObjections();
            objs = objs.filter(o => o.id !== id);
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            refreshObjections();
        }
        function refreshObjections() {
            const list = document.getElementById('obj-list');
            if(!list) return;
            const objs = getObjections();
            list.innerHTML = objs.map(o => `
                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 group">
                    <span class="flex-1 text-sm font-medium text-slate-700 dark:text-slate-200">${escapeHtml(o.text)}</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-black/20 rounded-lg p-1">
                        <button onclick="updateObjCount(${o.id}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-slate-500">-</button>
                        <span class="text-sm font-bold w-6 text-center text-slate-800 dark:text-white">${o.count}</span>
                        <button onclick="updateObjCount(${o.id}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-purple-500">+</button>
                    </div>
                    <button onclick="deleteObjection(${o.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // QUICK LINKS
        function renderQuickLinks() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="link" class="text-cyan-500"></i> Links R√°pidos
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="link-name" placeholder="Nome" class="w-1/3 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <input type="url" id="link-url" placeholder="URL (https://...)" class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <button onclick="addLink()" class="p-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="link-list" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getLinks() { return JSON.parse(localStorage.getItem('bh_links') || '[]'); }
        function addLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if(!name || !url) return;
            const links = getLinks();
            links.push({ id: Date.now(), name, url });
            localStorage.setItem('bh_links', JSON.stringify(links));
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            refreshLinks();
        }
        function deleteLink(id) {
            let links = getLinks();
            links = links.filter(l => l.id !== id);
            localStorage.setItem('bh_links', JSON.stringify(links));
            refreshLinks();
        }
        function refreshLinks() {
            const list = document.getElementById('link-list');
            if(!list) return;
            const links = getLinks();
            list.innerHTML = links.map(l => `
                <div class="relative group p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 hover:border-cyan-500/30 transition-all">
                    <a href="${escapeHtml(l.url)}" target="_blank" class="flex flex-col items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-center truncate w-full">${escapeHtml(l.name)}</span>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // AFFIRMATION
        function renderAffirmation() {
            const random = affirmations[Math.floor(Math.random() * affirmations.length)];
            return `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-20 h-20 rounded-full bg-yellow-500/10 flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-4 leading-tight">"${random}"</h2>
                    <p class="text-sm text-slate-500 font-medium uppercase tracking-widest">Mantra do Dia</p>
                </div>`;
        }


        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;
            const newSize = document.getElementById('set-fontsize').value;
            const newTone = document.getElementById('set-tone').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            if(newSize) {
                localStorage.setItem('bh_fontsize', newSize);
                applyFontSize(newSize);
            }

            if(newTone) {
                localStorage.setItem('bh_tone', newTone);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            setTimeout(toggleSettings, 500);
        }

        function applyFontSize(size) {
            document.documentElement.classList.remove('text-sm', 'text-base', 'text-lg');
            if(size !== 'text-sm') document.documentElement.classList.add(size);
        }

        function loadSettingsUI() {
            document.getElementById('set-username').value = localStorage.getItem('bh_username') || '';
            document.getElementById('set-apikey').value = localStorage.getItem('bh_apikey') || '';
            document.getElementById('set-webhook').value = localStorage.getItem('bh_webhook') || '';
            document.getElementById('set-fontsize').value = localStorage.getItem('bh_fontsize') || 'text-sm';
            document.getElementById('set-tone').value = localStorage.getItem('bh_tone') || 'professional';
        }

        function exportSettings() {
            const data = {
                username: localStorage.getItem('bh_username'),
                webhook: localStorage.getItem('bh_webhook'),
                theme: localStorage.getItem('bh_theme'),
                fontsize: localStorage.getItem('bh_fontsize'),
                tone: localStorage.getItem('bh_tone'),
                favorites: localStorage.getItem('bh_favorites'),
                links: localStorage.getItem('bh_links'),
                objections: localStorage.getItem('bh_objections')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthhub_config.json';
            a.click();
        }

        function importSettings() {
            document.getElementById('import-file').click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.username) localStorage.setItem('bh_username', data.username);
                    if(data.webhook) localStorage.setItem('bh_webhook', data.webhook);
                    if(data.theme) localStorage.setItem('bh_theme', data.theme);
                    if(data.fontsize) localStorage.setItem('bh_fontsize', data.fontsize);
                    if(data.tone) localStorage.setItem('bh_tone', data.tone);
                    if(data.favorites) localStorage.setItem('bh_favorites', data.favorites);
                    if(data.links) localStorage.setItem('bh_links', data.links);
                    if(data.objections) localStorage.setItem('bh_objections', data.objections);

                    showToast("Importado com Sucesso!");
                    setTimeout(() => location.reload(), 1000);
                } catch(err) {
                    showError("Erro na Importa√ß√£o", "Arquivo inv√°lido.");
                }
            };
            reader.readAsText(file);
        }

        async function sendToCRM() {
            const webhook = localStorage.getItem('bh_webhook');
            if(!webhook) { showError('Erro', 'Configure o Webhook nas configura√ß√µes.'); return; }

            const text = document.getElementById('t-output').innerText;
            if(!text || text.includes('Aguardando')) { showError('Erro', 'Nada para enviar.'); return; }

            try {
                showToast('Enviando...');
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        user: window.userName,
                        content: text
                    })
                });
                showToast('Enviado com Sucesso! üöÄ');
            } catch(e) {
                showError('Falha no Envio', e.message);
            }
        }

function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if(isHidden) {
                loadSettingsUI();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }
    </script>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity opacity-0">
        <div class="w-[90%] max-w-md glass rounded-3xl p-6 shadow-2xl scale-95 transition-transform duration-300 border border-white/10 relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 p-2 rounded-full hover:bg-white/10 transition-colors">
                <i data-lucide="x" class="w-4 h-4 text-slate-400"></i>
            </button>

            <h2 class="text-xl font-black uppercase tracking-tight mb-1 dark:text-white text-slate-900">Configura√ß√µes</h2>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6">Personalize sua experi√™ncia</p>

            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-brand-primary uppercase tracking-wider ml-2">Nome do Operador</label>
                    <input type="text" id="set-username" placeholder="Ex: Marcelo" class="w-full bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-xs font-medium outline-none focus:border-brand-primary/50 dark:text-white text-slate-800 transition-all">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-brand-primary uppercase tracking-wider ml-2">Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="set-apikey" placeholder="Cole sua chave AIza..." class="w-full bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-xs font-medium outline-none focus:border-brand-primary/50 dark:text-white text-slate-800 transition-all font-mono">
                        <i data-lucide="key" class="absolute right-4 top-3 w-4 h-4 text-slate-400 opacity-50"></i>
                    </div>
                    <p class="text-[9px] text-slate-500 ml-2">Sua chave √© salva apenas no navegador (LocalStorage).</p>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-brand-primary uppercase tracking-wider ml-2">Webhook CRM (Zapier/n8n)</label>
                    <div class="relative">
                        <input type="url" id="set-webhook" placeholder="https://hooks.zapier.com/..." class="w-full bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-xs font-medium outline-none focus:border-brand-primary/50 dark:text-white text-slate-800 transition-all font-mono">
                        <i data-lucide="webhook" class="absolute right-4 top-3 w-4 h-4 text-slate-400 opacity-50"></i>
                    </div>
                </div>
                <!-- New Settings -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-brand-primary uppercase tracking-wider ml-2">Tamanho Fonte</label>
                        <select id="set-fontsize" class="w-full bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-xs font-medium outline-none focus:border-brand-primary/50 dark:text-white text-slate-800 transition-all appearance-none">
                            <option value="text-sm">Padr√£o</option>
                            <option value="text-base">M√©dio</option>
                            <option value="text-lg">Grande</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-brand-primary uppercase tracking-wider ml-2">Tom de Voz</label>
                        <select id="set-tone" class="w-full bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-xs font-medium outline-none focus:border-brand-primary/50 dark:text-white text-slate-800 transition-all appearance-none">
                            <option value="professional">Profissional</option>
                            <option value="casual">Casual</option>
                            <option value="enthusiastic">Entusiasta</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-2 mt-6 border-t border-white/5 pt-4">
                    <button onclick="exportSettings()" class="flex-1 py-2 bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 rounded-xl text-slate-500 dark:text-slate-300 text-[10px] font-bold uppercase tracking-wider transition-all">
                        <i data-lucide="download" class="w-3 h-3 inline mr-1"></i> Backup Config
                    </button>
                    <button onclick="importSettings()" class="flex-1 py-2 bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 rounded-xl text-slate-500 dark:text-slate-300 text-[10px] font-bold uppercase tracking-wider transition-all">
                        <i data-lucide="upload" class="w-3 h-3 inline mr-1"></i> Restaurar
                    </button>
                    <input type="file" id="import-file" class="hidden" onchange="processImport(this)">
                </div>

            </div>

            <div class="mt-8 pt-4 border-t border-white/5 flex gap-3">
                <button onclick="saveSettings()" class="flex-1 py-3 bg-brand-primary rounded-xl text-white text-xs font-black uppercase tracking-widest shadow-lg shadow-brand-primary/20 hover:scale-[1.02] active:scale-95 transition-all">
                    Salvar Dados
                </button>
            </div>
        </div>
    </div>
    <script>lucide.createIcons();
        // --- NEW WIDGETS LOGIC ---

        // POMODORO
        let pomodoroInterval;
        let pomodoroTime = 25 * 60;
        let isPomodoroRunning = false;

        function renderPomodoro() {
            return `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-bold mb-8 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="clock" class="text-red-500"></i> Pomodoro
                    </h2>
                    <div class="text-7xl font-mono font-bold text-slate-800 dark:text-white mb-8" id="pomo-display">
                        ${formatTime(pomodoroTime)}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="togglePomodoro()" id="pomo-btn" class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-bold text-lg transition-all shadow-lg shadow-red-500/30">
                            INICIAR
                        </button>
                        <button onclick="resetPomodoro()" class="px-6 py-3 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-2xl text-slate-600 dark:text-white font-bold transition-all">
                            RESET
                        </button>
                    </div>
                </div>`;
        }
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (isPomodoroRunning) {
                clearInterval(pomodoroInterval);
                isPomodoroRunning = false;
                btn.innerText = 'CONTINUAR';
                btn.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                isPomodoroRunning = true;
                btn.innerText = 'PAUSAR';
                btn.classList.replace('bg-red-500', 'bg-orange-500');
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    if(pomodoroTime <= 0) {
                        clearInterval(pomodoroInterval);
                        isPomodoroRunning = false;
                        document.getElementById('pomo-display').innerText = "00:00";
                        alert("Pomodoro Finalizado!"); // Simple alert
                        resetPomodoro();
                    } else {
                        document.getElementById('pomo-display').innerText = formatTime(pomodoroTime);
                    }
                }, 1000);
            }
        }
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            pomodoroTime = 25 * 60;
            const display = document.getElementById('pomo-display');
            const btn = document.getElementById('pomo-btn');
            if(display) display.innerText = "25:00";
            if(btn) { btn.innerText = "INICIAR"; btn.classList.remove('bg-orange-500'); btn.classList.add('bg-red-500'); }
        }

        // WORLD CLOCK
        let worldClockInterval;
        function renderWorldClock() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="globe" class="text-blue-500"></i> Rel√≥gio Mundial
                    </h2>
                    <div id="world-clocks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Clocks -->
                    </div>
                </div>`;
        }
        function startWorldClock() {
            updateWorldClocks();
            if(worldClockInterval) clearInterval(worldClockInterval);
            worldClockInterval = setInterval(updateWorldClocks, 1000);
        }
        function updateWorldClocks() {
            const zones = [
                { label: 'S√£o Paulo', tz: 'America/Sao_Paulo' },
                { label: 'New York', tz: 'America/New_York' },
                { label: 'London', tz: 'Europe/London' },
                { label: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            const container = document.getElementById('world-clocks');
            if(!container) return;

            container.innerHTML = zones.map(z => {
                const time = new Date().toLocaleTimeString('en-US', { timeZone: z.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                const date = new Date().toLocaleDateString('pt-BR', { timeZone: z.tz, day: 'numeric', month: 'short' });
                return `
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${z.label}</span>
                    <span class="text-3xl font-mono font-bold text-slate-800 dark:text-white">${time}</span>
                    <span class="text-[10px] text-slate-500">${date}</span>
                </div>`;
            }).join('');
        }

        // OBJECTION COUNTER
        function renderObjectionCounter() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="trello" class="text-purple-500"></i> Contador de Obje√ß√µes
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="obj-input" placeholder="Nova Obje√ß√£o..." class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 text-slate-800 dark:text-white" onkeydown="if(event.key==='Enter') addObjection()">
                        <button onclick="addObjection()" class="p-2 bg-purple-500 hover:bg-purple-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="obj-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getObjections() { return JSON.parse(localStorage.getItem('bh_objections') || '[]'); }
        function addObjection() {
            const input = document.getElementById('obj-input');
            const text = input.value.trim();
            if(!text) return;
            const objs = getObjections();
            objs.push({ id: Date.now(), text, count: 0 });
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            input.value = '';
            refreshObjections();
        }
        function updateObjCount(id, delta) {
            const objs = getObjections();
            const obj = objs.find(o => o.id === id);
            if(obj) {
                obj.count = Math.max(0, obj.count + delta);
                localStorage.setItem('bh_objections', JSON.stringify(objs));
                refreshObjections();
            }
        }
        function deleteObjection(id) {
            let objs = getObjections();
            objs = objs.filter(o => o.id !== id);
            localStorage.setItem('bh_objections', JSON.stringify(objs));
            refreshObjections();
        }
        function refreshObjections() {
            const list = document.getElementById('obj-list');
            if(!list) return;
            const objs = getObjections();
            list.innerHTML = objs.map(o => `
                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 group">
                    <span class="flex-1 text-sm font-medium text-slate-700 dark:text-slate-200">${escapeHtml(o.text)}</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-black/20 rounded-lg p-1">
                        <button onclick="updateObjCount(${o.id}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-slate-500">-</button>
                        <span class="text-sm font-bold w-6 text-center text-slate-800 dark:text-white">${o.count}</span>
                        <button onclick="updateObjCount(${o.id}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded text-purple-500">+</button>
                    </div>
                    <button onclick="deleteObjection(${o.id})" class="text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // QUICK LINKS
        function renderQuickLinks() {
            return `
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-white">
                        <i data-lucide="link" class="text-cyan-500"></i> Links R√°pidos
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="link-name" placeholder="Nome" class="w-1/3 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <input type="url" id="link-url" placeholder="URL (https://...)" class="flex-1 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-cyan-500 text-slate-800 dark:text-white">
                        <button onclick="addLink()" class="p-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="link-list" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>`;
        }
        function getLinks() { return JSON.parse(localStorage.getItem('bh_links') || '[]'); }
        function addLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if(!name || !url) return;
            const links = getLinks();
            links.push({ id: Date.now(), name, url });
            localStorage.setItem('bh_links', JSON.stringify(links));
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            refreshLinks();
        }
        function deleteLink(id) {
            let links = getLinks();
            links = links.filter(l => l.id !== id);
            localStorage.setItem('bh_links', JSON.stringify(links));
            refreshLinks();
        }
        function refreshLinks() {
            const list = document.getElementById('link-list');
            if(!list) return;
            const links = getLinks();
            list.innerHTML = links.map(l => `
                <div class="relative group p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 hover:border-cyan-500/30 transition-all">
                    <a href="${escapeHtml(l.url)}" target="_blank" class="flex flex-col items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-center truncate w-full">${escapeHtml(l.name)}</span>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // AFFIRMATION
        const affirmations = [
            "Voc√™ √© capaz de fechar qualquer neg√≥cio.",
            "O 'n√£o' √© apenas um degrau para o 'sim'.",
            "Voc√™ resolve problemas reais de pessoas reais.",
            "Sua confian√ßa √© contagiante.",
            "Vender √© ajudar.",
            "Hoje √© um √≥timo dia para bater meta.",
            "Escute mais, fale menos.",
            "Persist√™ncia vence resist√™ncia.",
            "Voc√™ √© um consultor de confian√ßa.",
            "Cada obje√ß√£o √© uma oportunidade de agregar valor."
        ];
        function renderAffirmation() {
            const random = affirmations[Math.floor(Math.random() * affirmations.length)];
            return `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-20 h-20 rounded-full bg-yellow-500/10 flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-4 leading-tight">"${random}"</h2>
                    <p class="text-sm text-slate-500 font-medium uppercase tracking-widest">Mantra do Dia</p>
                </div>`;
        }


        function saveSettings() {
            const newName = document.getElementById('set-username').value;
            const newKey = document.getElementById('set-apikey').value;
            const newWebhook = document.getElementById('set-webhook').value;
            const newSize = document.getElementById('set-fontsize').value;
            const newTone = document.getElementById('set-tone').value;

            if(newName) {
                window.userName = newName.toUpperCase();
                localStorage.setItem('bh_username', window.userName);
                const greeting = document.getElementById('greeting-text');
                if(greeting) greeting.innerText = `${window.userName} ONLINE`;
        const savedSize = localStorage.getItem('bh_fontsize');
        if(savedSize) applyFontSize(savedSize);
            }

            if(newKey) {
                window.apiKey = newKey;
                localStorage.setItem('bh_apikey', window.apiKey);
                endpoints = getEndpoints();
            }

            if(newWebhook !== undefined) {
                 window.crmUrl = newWebhook;
                 localStorage.setItem('bh_webhook', window.crmUrl);
            }

            if(newSize) {
                localStorage.setItem('bh_fontsize', newSize);
                applyFontSize(newSize);
            }

            if(newTone) {
                localStorage.setItem('bh_tone', newTone);
            }

            showToast("CONFIGURA√á√ïES SALVAS! üíæ");
            setTimeout(toggleSettings, 500);
        }

        function applyFontSize(size) {
            document.documentElement.classList.remove('text-sm', 'text-base', 'text-lg');
            if(size !== 'text-sm') document.documentElement.classList.add(size);
        }

        function loadSettingsUI() {
            document.getElementById('set-username').value = localStorage.getItem('bh_username') || '';
            document.getElementById('set-apikey').value = localStorage.getItem('bh_apikey') || '';
            document.getElementById('set-webhook').value = localStorage.getItem('bh_webhook') || '';
            document.getElementById('set-fontsize').value = localStorage.getItem('bh_fontsize') || 'text-sm';
            document.getElementById('set-tone').value = localStorage.getItem('bh_tone') || 'professional';
        }

        function exportSettings() {
            const data = {
                username: localStorage.getItem('bh_username'),
                webhook: localStorage.getItem('bh_webhook'),
                theme: localStorage.getItem('bh_theme'),
                fontsize: localStorage.getItem('bh_fontsize'),
                tone: localStorage.getItem('bh_tone'),
                favorites: localStorage.getItem('bh_favorites'),
                links: localStorage.getItem('bh_links'),
                objections: localStorage.getItem('bh_objections')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthhub_config.json';
            a.click();
        }

        function importSettings() {
            document.getElementById('import-file').click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.username) localStorage.setItem('bh_username', data.username);
                    if(data.webhook) localStorage.setItem('bh_webhook', data.webhook);
                    if(data.theme) localStorage.setItem('bh_theme', data.theme);
                    if(data.fontsize) localStorage.setItem('bh_fontsize', data.fontsize);
                    if(data.tone) localStorage.setItem('bh_tone', data.tone);
                    if(data.favorites) localStorage.setItem('bh_favorites', data.favorites);
                    if(data.links) localStorage.setItem('bh_links', data.links);
                    if(data.objections) localStorage.setItem('bh_objections', data.objections);

                    showToast("Importado com Sucesso!");
                    setTimeout(() => location.reload(), 1000);
                } catch(err) {
                    showError("Erro na Importa√ß√£o", "Arquivo inv√°lido.");
                }
            };
            reader.readAsText(file);
        }

        async function sendToCRM() {
            const webhook = localStorage.getItem('bh_webhook');
            if(!webhook) { showError('Erro', 'Configure o Webhook nas configura√ß√µes.'); return; }

            const text = document.getElementById('t-output').innerText;
            if(!text || text.includes('Aguardando')) { showError('Erro', 'Nada para enviar.'); return; }

            try {
                showToast('Enviando...');
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        user: window.userName,
                        content: text
                    })
                });
                showToast('Enviado com Sucesso! üöÄ');
            } catch(e) {
                showError('Falha no Envio', e.message);
            }
        }

function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if(isHidden) {
                loadSettingsUI();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }
    </script>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-[400] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity opacity-0">
        <div class="w-[90%] max-w-sm bg-white dark:bg-[#1a1b26] border border-red-500/20 rounded-2xl p-6 shadow-2xl scale-95 transition-transform duration-300 relative">
            <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center mb-4 mx-auto">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
            </div>
            <h3 class="text-lg font-bold text-center text-slate-800 dark:text-white mb-2" id="error-title">Erro</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 text-center mb-6" id="error-msg">Ocorreu um erro inesperado.</p>
            <button onclick="closeError()" class="w-full py-2.5 bg-red-500 hover:bg-red-600 rounded-xl text-white text-xs font-bold uppercase tracking-wider transition-all">
                Entendi
            </button>
        </div>
    </div>

</body>
</html>